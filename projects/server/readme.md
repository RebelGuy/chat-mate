The server is responsible for fetching data from Youtube via the `masterchat` project, and from Twitch via the `@twurple` package. It exposes this chat data, as well as additional functionality, via a REST API.



# Project Details
Built JavaScript files live in the `./dist` folder, while generated data lives in the `./data` folder.

Note: If fetching Youtube metadata incurs a "Rate limit exceeded" error, then Youtube has flagged us as a bot. A (temporary?) solution is to regenerate an auth token (see below).

Twitch's EventSub notifies us of new events via a webhook. To set up the listener on our local machine, we use `ngrok` (https://ngrok.com/download). See https://twurple.js.org/docs/getting-data/eventsub/listener-setup.html for more details.

An SSL certificate for use by the Twitch EventSub can be generated by opening a git terminal and running the command `openssl req -newkey rsa:2048 -nodes -keyout key.pem -x509 -days 365 -out certificate.pem`.

Note: Importing modules from Twurple must be done from the package level, `@twurple/<package-name>`, rather than `@twurple/<package-name>/lib` (unfortunately VSCode defaults to this type of importing, which will result in a runtime error). 


## Scripts for development:
1. `yarn install`.
2. `yarn auth` to fetch the authentication credentials for YouTube, and `yarn auth:twitch:<debug|release>`. Copy them from the console and set them in the [`.env`](#.env) file.
3. `yarn watch` while developing
4. `yarn start:debug` to run the debug server, or `yarn start:mock` to run a mock server that will automatically feed through new messages for easy client-side testing - see `MockMasterchat` for more info and options. Note that this does not bundle up the application. For a debug bundle that mirrors the release build, use `yarn build:debug`.

Alternatively, run `yarn build:debug` to bundle the debug app to the same format as what is used in release.
If building fails because the Prisma client could not be found, please run `yarn generate`.

## Scripts for production:
Assumes that steps 1-3 of the previous section have been run.
3. `yarn build:release` bundles the application as `./dist/server/app.js`.
4. `yarn migrate:release` migrate the database to the latest schema
5. `yarn start:release` to run the release server


## Authentication
### YouTube
Run `yarn auth` and log in using the streaming account, or a moderator account. After the Electron app closes, note the authentication token in the console and use it as the `AUTH` environment variable.

### Twitch
Enure you create an application on the [Twitch Developer Console](https://dev.twitch.tv/console/apps). Note down the application ID and secret and set the relevant environment variables. These will not change in the future.

For the initial authentication, you will need to start the Electron app via `yarn auth:twitch:<debug|release>` and sign in manually. After the Electron app closes, note the access token and refresh token printed in the console and set the relevant environment variables. The next time the project is run, these will be stored in the database (`twitch_auth` table) and retrieved thereon, so the variables can be safely removed before subsequent runs.

Important: The application scope is hardcoded in `TwurpleAuthProvider.ts` at the moment. Making any changes to the scope will require that you delete the single row in the `twitch_auth` table and follow the steps above to repeat the initial authentication process.

# .env
Define a `debug.env` and `release.env` file that sets the following environment variables, one per line, in the format `KEY=value`. The `template.env` file can be used as a template. **On Azure, these variables must be set manually in the app service's configuration.**

The following environment variables must be set in the `.env` file:
- `PORT`: Which port the server should run on.
- `AUTH`: The authentication credentials for the livestream user. Optional. Credentials can be obtained by running the electron app via `yarn auth`, logging into the Google account, and copying the encoded cookie token that is displayed in the console.
- `CHANNEL_ID`: The channel ID of the livestream user.
- `TWITCH_CLIENT_ID`: The client ID for twitch auth (from https://dev.twitch.tv/console/apps).
- `TWITCH_CLIENT_SECRET`: The client secret for twitch auth.
- `TWITCH_ACCESS_TOKEN`: The access token retrieved from `yarn auth:twitch:debug` or `yarn auth:twitch:release`. This is required only when running the server for the first time, or when prompted.
- `TWITCH_REFRESH_TOKEN`: The refresh token retrieved from `yarn auth:twitch:debug` or `yarn auth:twitch:release`. This is required only when running the server for the first time, or when prompted.
- `TWITCH_CHANNEL_NAME`: The Twitch channel's name from which we should connect (must have at least moderator permissions).
- `DATABASE_URL`: The connection string to the MySQL database that Prisma should use. **Please ensure you append `?pool_timeout=30&connect_timeout=30` to the connection string (after the database name)** to prevent timeouts during busy times. More options can be found at https://www.prisma.io/docs/concepts/database-connectors/mysql
  - The local database connection string for the debug database is `mysql://root:root@localhost:3306/chat_mate_debug?connection_limit=5&pool_timeout=30&connect_timeout=30`
  - The remote database connection string for the debug database is `mysql://chatmateadmin:{{password}}@chat-mate.mysql.database.azure.com:3306/chat_mate_debug?connection_limit=5&pool_timeout=30&connect_timeout=30`
- `ENABLE_DB_LOGGING`: [Optional, defaults to `false`] Whether to include database-related actions in the logs. Note that, even if this is `false`, any warning and errors will still be included.

The following set of environment variables is available only for **local development** (that is, where `IS_LOCAL` is `true`):
- `USE_FAKE_CONTROLLERS`: [Optional, defaults to `false`] If true, replaces some controllers with test-only implementations that generate fake data. This also disables communication with external APIs (that is, it is run entirely offline).

The following set of environmnet variables is available only for **deployed instances** (that is, where `IS_LOCAL` is `false`):
- `APPLICATIONINSIGHTS_CONNECTION_STRING`: The connection string to use for connecting to the Azure Application Insights service. *This is set automatically by Azure.*
- `HOST_NAME`: The host name at which the deployed server is reachable, e.g. `example.com`. *This is set automatically by Azure.*

In addition, the following environment variables must be injected into the node instance using the `cross-env` package:
- `NODE_ENV`: Either `debug` or `release` to indicate whether we are connecting to debug or release servers.
- `BUILD`: Either `tsc` or `webpack` to indicate the build method. This is used for some module resolution workarounds at runtime.
- `IS_LOCAL`: [Optional, defaults to `false`] Whether we are running the server locally, or in a deployed environment.

For testing, define a `test.env` file that sets only a subset of the above variables:
- `DATABASE_URL`

## Database

The `debug` MySQL database is named `chat_mate_debug`, while the `release` database is named `chat_mate`, and the `test` database is named `chat_mate_test`. Ensure the `DATABASE_URL` connection string is set in the respective [`.env`](#.env) file.

`Prisma` is used as both the ORM and typesafe interface to manage communications with the underlying MySQL database. Run `yarn migrate:debug` to sync the local DB with the checked-out migrations and generate an up-to-date Prisma Client.

At any point where the prisma file (`prisma.schema` - the database schema) is modified, `yarn generate` can be run to immediately regenerate the Prisma Client for up-to-date typings. This should also be run if the project structure changes in some way. No actual database changes are performed as part of this command. For more help and examples with using the Prisma Client and querying, see https://www.prisma.io/docs/concepts/components/prisma-client.

Run `yarn migrate:schema` to generate a new `migration.sql` file for updating the MySQL database, which will automatically be opened for editing. Note that while this migration is not applied, any earlier unapplied migrations will be executed prior to generating the new migration. All outstanding migrations can be applied explicitly, and a new Prisma Client generated, using `yarn migrate:debug`.

During a migration, ensure that the `.sql` is checked and edited to avoid data loss, but avoid making manual changes that affect the database schema, other than the ones already present.

`yarn migrate:release` deploys changes to the production environment. Only uses migration files, NOT the Prisma schema file.

## Punishments
Punishments are used to temporarily or permanently hide users' livestream messages. Any punishment can be revoked at any time. Punishment reasons and revoke reasons are supported but optional. Punishments can be either temporary or permanent, depending on the type.

Currently there are 3 punishment types:
1. `mute`: This is an internal punishment, and is used by the client to hide messages of a certain user. A mute can be temporary or permanent.
2. `timeout`: This is both internal and external (i.e. sent to YouTube and Twitch) and completely stops the user from sending messages in the livestream chat. It is always temporary. Due to limitations with the Masterchat implementation, timeouts must be at least 5 minutes long. Furthermore, we have a service that refreshes YouTube timeouts periodically if they are longer than 5 minutes.
3. `ban`: This is essentially a permanent timeout.

## Testing
`yarn test` performs the test suite.
`yarn test:db` Sets up the test database.
`yarn test <file regex>` includes only tests within files matching the expression.

Further, to filter individual tests, temporarily replace `test()` with `test.only()`. All `test()`s will then be skipped.

Due to concurrency issues, all tests using the test database will need to be run from the central `_test/stores.test.ts` file. It imports the `<StoreName>.suite.ts` files which contain the actual test, then run them one-by-one.

### Current test coverage
Over time, aim to add tests to all public methods of all services and stores.
Key:
- 🔴: No tests
- 🟡: In progress/incomplete tests
- 🟢: Full test coverage
- ⚪: Won't do

**Services**
- ⚪ ApplicationInsightsService
- 🟢 ChannelService
  - 🟢 getActiveUserChannel
  - 🟢 getActiveUserChannels
  - 🟢 getUserByChannelName
  - 🟢 getUserById
- 🟢 ChatService
  - 🟢 initialise
  - 🟢 onNewChatItem
- 🟢 ChatFetchService
  - 🟢 initialise
- 🟢 EmojiService
  - 🟢 applyCustomEmojis
- 🟢 ExperienceService
  - 🟢 addExperienceForChat
  - 🟢 getLeaderboard
  - 🟢 getLevel
  - 🟢 getLevelDiffs
  - 🟢 modifyExperience
- ⚪ EventDispatchService
- 🟢 LivestreamService
  - 🟢 initialise
  - 🟢 deactivateLivestream
  - 🟢 setActiveLivestream
- 🟢 MasterchatProxyService
  - 🟢 addMasterchat
  - 🟢 fetch
  - 🟢 fetchMetadata
  - 🟢 removeMasterchat
- 🟢 PunishmentService
  - 🟢 initialise
  - 🟢 banUser
  - 🟢 isUserPunished
  - 🟢 muteUser
  - 🟢 timeoutUser
  - 🟢 getCurrentPunishments
  - 🟢 unbanUser
  - 🟢 unmuteUser
  - 🟢 untimeoutUser
- 🟢 StatusService
  - 🟢 getApiStatus
  - 🟢 onRequestDone
- 🟢 TwurpleApiProxyService
  - ⚪ ban
  - 🟢 fetchMetadata
  - ⚪ say
  - ⚪ timeout
- 🟢 TwurpleService
  - 🟢 banChannel
  - 🟢 initialise
  - 🟢 unbanChannel
- 🟢 YoutubeTimeoutRefreshService
  - 🟢 startTrackingTimeout
  - 🟢 stopTrackingTimeout
- ⚪ FileService
- ⚪ LogService

**Stores**
- 🟢 AuthStore
  - 🟢 loadAccessToken
  - 🟢 saveAccessToken
- 🟢 ChannelStore
  - 🟢 createOrUpdate
  - 🟢 getCurrentUserIds
  - 🟢 getCurrentUserNames
  - 🟢 getTwitchUserNameFromChannelId
  - 🟢 getYoutubeChannelNameFromChannelId
  - 🟢 getUserId
  - 🟢 getUserOwnedChannels
- 🟢 ChatStore
  - 🟢 addChat
  - 🟢 getChatSince
  - 🟢 getLastChatByYoutubeChannel
  - 🟢 getLastChatByUser
- 🟢 CustomEmojiStore
  - 🟢 addCustomEmoji
  - 🟢 getAllCustomEmojis
  - 🟢 updateCustomEmoji
- 🟢 ExperienceStore
  - 🟢 addChatExperience
  - 🟢 addManualExperience
  - 🟢 getSnapshot
  - 🟢 getPreviousChatExperience
  - 🟢 getAllTransactionsStartingAt
  - 🟢 getTotalDeltaStartingAt
- 🟢 FollowerStore
  - 🟢 getFollowersSince
  - 🟢 saveNewFollower
- 🟢 LivestreamStore
  - 🟢 initialise
  - 🟢 currentLivestream
  - 🟢 deactivateLivestream
  - 🟢 setActiveLivestream
  - 🟢 setContinuationToken
  - 🟢 setTimes
- 🟢 PunishmentStore
  - 🟢 addPunishment
  - 🟢 getPunishments
  - 🟢 getPunishmentsForUser
  - 🟢 revokePunishment
- 🟢 ViewershipStore
  - 🟢 addLiveViewCount
  - 🟢 addViewershipForChatParticipation
  - 🟢 getLastSeen
  - 🟢 getLatestLiveCount
  - 🟢 getLivestreamParticipation
  - 🟢 getLivestreamViewership

**Providers**
- 🟢 TwurpleAuthProvider
  - 🟢 initialise

**Helpers**
- ⚪ DateTimeHelpers
  - ⚪ now
  - ⚪ ts
- 🟢 ExperienceHelpers
  - 🟢 calculateChatMessageQuality
  - 🟢 calculateExperience
  - 🟢 calculateLevel
  - 🟢 calculateParticipationMultiplier
  - 🟢 calculateQualityMultiplier
  - 🟢 calculateRepetitionPenalty
  - 🟢 calculateSpamMultiplier
  - 🟢 calculateViewershipMultiplier
- 🟢 TimerHelpers
  - 🟢 createRepeatingTimer
  - 🟢 disposeSingle
  - 🟢 dispose

**Misc**
- 🔴 util/math
- 🔴 util/score


# API Endpoints

Use the API endpoints to communicate with the server while it is running. The API base URL is `http://localhost:3010/api`.

A response contains the following properties:
- `schema` (`number`): The current schema of the return object. Every time there is a change, this will be bumped up by one to avoid inconsistencies between the server and client.
- `timestamp` (`number`): The unix timestamp (in ms) at which the response was generated.
- `success` (`boolean`): True if the request was processed correctly, and false otherwise.
- `data` (`object`): Only included if `success` is `true`. Contains the response data, outlined for each endpoint below.
- `error` (`object`): Only included if `success` is `false`. Contains the following properties:
  - `errorCode` (`number`): The HTTP error code that most closely matches the type of problem encountered.
  - `errorType` (`string`): The general type of error encounterd.
  - `message` (`string`): An optional error message describing what went wrong.

Note that a `500` error can be expected for all endpoints, but any other errors should be documented specifically in the below sections.

All non-primitive properties of `data` are of type `PublicObject`, which are reusable, schema-tagged objects which themselves contain either primitive types or other `PublicObject`s. The schema definitions for these can be found in the `./controllers/public` folder and will not be reproduced here. Please ensure the client's model is in sync at all times. The schema of an object should be bumped whenever a property of this object, or one of its children changes. That is, schema changes should cascade upwards until reaching the controller levels.

Any data in the request body should also have a schema. This is always in sync with the schema version of the response object.

## Chat Endpoints
Path: `/chat`.

### `GET`
*Current schema: 7.*

Retrieves the latest chat items.

Query parameters:
- `since` (`number`): *Optional.* Gets only chat items **after** the given time (unix ms).
- `limit` (`number`): *Optional.* Limits the number of returned chat items. Defaults to 100.

Returns data with the following properties:
- `reusableTimestamp` (`number`): The timestamp of the latest chat item. Use this value as the `since` query parameter in the next request for continuous data flow (no duplicates).
- `chat` (`PublicChatItem[]`): The chat data that satisfy the request filter, sorted in ascending order by time.

## ChatMate Endpoints
Path: `/chatMate`.

### `GET /status`
*Current schema: 3.*

Gets the latest status information.

Returns data with the following properties:
- `livestreamStatus` (`PublicLivestreamStatus | null`): Status information relating to the active public livestream. Null if there is no active public livestream.
- `youtubeApiStatus` (`PublicApiStatus`): Status information relating to the YouTube API.
- `twitchApiStatus` (`PublicApiStatus`): Status information relating to the YouTube API.

### `GET /events`
*Current schema: 4.*

Gets the events that have occurred since the specified time.

Query parameters:
- `since` (`number`): *Required.* Gets only events **after** the given time (unix ms).

Returns data with the following properties:
- `reusableTimestamp` (`number`): Use this value as the `since` query parameter in the next request for continuous data flow (no duplicates).
- `events` (`PublicChatMateEvent[]`): The list of events that have occurred since the given timestamp.

Can return the following errors:
- `400`: When the required query parameters have not been provided.

### `PATCH /livestream`
*Current schema: 2.*

Sets the active public livestream. Note that an active livestream cannot be set if another one is already active. Please deactivate the existing one first (see below).

Request data (body):
- `livestream` (`string | null`): *Required.* The livestream link or id to set as active. If `null`, the active stream will be deactivated.

Returns data with the following properties:
- `livestreamLink` (`string | null`): The new livestream link.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.
- `422`: When an active livestream already exists.

## Emoji Endpoints
Path: `/emoji`.

### `GET /custom`
*Current schema: 1.*

Gets all custom emojis.

Returns data with the following properties:
- `emojis` (`PublicCustomEmoji[]`): The list of all custom emojis.

### `POST /custom`
*Current schema: 1.*

Add a new custom emoji.

Request data (body):
- `newEmoji` (`PublicCustomEmojiNew`): *Required.* The new emoji's data. Note that the `symbol` must be unique, otherwise the request will get rejected.

Returns data with the following properties:
- `newEmoji` (`PublicCustomEmoji`): The new emoji that was created.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `PATCH /custom`
*Current schema: 1.*

Update an existing custom emoji.

Request data (body):
- `updatedEmoji` (`PublicCustomEmoji`): *Required.* The updated emoji's data. Note that the `symbol` must be unique, otherwise the request will get rejected. The `id` is used to match the new emoji to an emoji in the database.

Returns data with the following properties:
- `updatedEmoji` (`PublicCustomEmoji`): The updated emoji data.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

## Experience Endpoints
Path: `/experience`.

### `GET /leaderboard`
*Current schema: 3.*

Gets the ranked experience list of all users.

Returns data with the following properties:
- `rankedUsers` (`PublicRankedUser[]`): The array of every user's rank, sorted in ascending order.

### `GET /rank`
*Current schema: 3.*

Gets the rank of a specific user, as well as some context. Essentially, it returns a sub-section of the data from `GET /leaderboard`.

Query parameters:
- `id` (`number`): *Required.* The id of the user for which the rank is to be returned.

Returns data with the following properties:
- `relevantIndex` (`number`): The index of the entry in `entries` that belongs to the matched channel. Never negative.
- `rankedUsers` (`PublicRankedUser[]`): The partial leaderboard in ascending order, which includes the matched channel. Never empty.

Can return the following errors:
- `400`: When the required query parameters have not been provided.
- `404`: When no channel could be matched against the search query.

### `POST /modify`
*Current schema: 2.*

Modifies a player's experience by adding a special admin transaction.

Request data (body):
- `userId` (`int`): *Required.* The user whose experience should be modified.
- `deltaLevels` (`float`): *Required.* How many levels to add or take away. This can be a fractional value. A user's current fractional level is given by `levelInfo.level + levelInfo.levelProgress`.
  message: (`string`): *Optional.* A custom message to add as part of the transaction.

Returns data with the following properties:
- `updatedUser` (`PublicUser`): The user object after the experience change has been applied.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.
- `404`: When the given user is not found.

## Punishment Endpoints
Path: `/punishment`.

### `GET /:id`
*Current schema: 1.*

Gets a punishment by id.

Path parameters:
- `id` (`number`): *Required.* The ID of the punishment to retrieve.

Returns data with the following properties:
- `punishment` (`PublicPunishment`): The punishment matching the specified id.

Can return the following errors:
- `404`: When a punishment with the specifed id could not be found.

### `GET`
*Current schema: 1.*

Gets the list of all punishments for a user.

Query parameters:
- `userId` (`number`): *Optional.* The ID of the user for which to get punishments. If not provided, returns punishments for all users.
- `activeOnly` (`boolean`): *Optional.* If true, returns only punishments that are currently active.

Returns data with the following properties:
- `punishments` (`PublicPunishment[]`): The list of punishments of the user, in descending order by time issued.

Can return the following errors:
- `400`: When the required query parameters have not been provided.

### `POST /ban`
*Current schema: 2.*

Applies a punishment of type `ban` to the user. This is essentially a permanent `timeout`.

Request data (body):
- `userId` (`int`): *Required.* The user to which the punishment should be applied.
- `message` (`string`): *Optional.* The reason for the punishment.

Returns data with the following properties:
- `newPunishment` (`PublicPunishment`): The new punishment that was created as a result of this request.
- `channelPunishments` (`PublicChannelPunishment[]`): The external punishments applied to channels on YouTube or Twitch.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `POST /unban`
*Current schema: 2.*

Revokes an existing `ban` punishment from the user. This may also be used to remove any residual bans on the external platforms.

Request data (body):
- `userId` (`int`): *Required.* The user from which the punishment should be revoked.
- `message` (`string`): *Optional.* The reason for revoking the punishment.

Returns data with the following properties:
- `updatedPunishment` (`PublicPunishment | null`): The updated punishment data. Null if no current punishment was found.
- `channelPunishments` (`PublicChannelPunishment[]`): The external punishments revoked from channels on YouTube or Twitch. Note that these are executed regardless of whether an internal punishment was found or not.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `POST /timeout`
*Current schema: 2.*

Applies a punishment of type `timeout` to the user. This is essentially a temporary `ban`.

Request data (body):
- `userId` (`int`): *Required.* The user to which the punishment should be applied.
- `message` (`string`): *Optional.* The reason for the punishment.
- `durationSeconds` (`number`): *Required.* The duration of the punishment, in seconds. Must be at least 5 minutes.

Returns data with the following properties:
- `newPunishment` (`PublicPunishment`): The new punishment that was created as a result of this request.
- `channelPunishments` (`PublicChannelPunishment[]`): The external punishments applied to channels on YouTube or Twitch.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `POST /revokeTimeout`
*Current schema: 2.*

Revokes an existing `timeout` punishment from the user. This may also be used to remove any residual timeouts on the external platforms.

Request data (body):
- `userId` (`int`): *Required.* The user from which the punishment should be revoked.
- `message` (`string`): *Optional.* The reason for revoking the punishment.

Returns data with the following properties:
- `updatedPunishment` (`PublicPunishment | null`): The updated punishment data. Null if no current punishment was found.
- `channelPunishments` (`PublicChannelPunishment[]`): The external punishments revoked from channels on YouTube or Twitch. Note that these are executed regardless of whether an internal punishment was found or not.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `POST /mute`
*Current schema: 1.*

Applies a punishment of type `mute` to the user.

Request data (body):
- `userId` (`int`): *Required.* The user to which the punishment should be applied.
- `message` (`string`): *Optional.* The reason for the punishment.
- `durationSeconds` (`number`): *Optional.* The duration of the punishment, in seconds. If 0 or not provided, the punishment is permanent.

Returns data with the following properties:
- `newPunishment` (`PublicPunishment`): The new punishment that was created as a result of this request.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `POST /unmute`
*Current schema: 1.*

Revokes an existing `mute` punishment from the user.

Request data (body):
- `userId` (`int`): *Required.* The user from which the punishment should be revoked.
- `message` (`string`): *Optional.* The reason for revoking the punishment.

Returns data with the following properties:
- `updatedPunishment` (`PublicPunishment | null`): The updated punishment data. Null if no current punishment was found.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

## User Endpoints
Path: `/user`.

### `POST /search`
*Current schema: 3.*

Search for a specific user.

Request data (body):
- `searchTerm` (`string`): *Required.* The string to search in user's channel names.

Returns data with the following properties:
- `results` (`PublicUserNames[]`): An array containing the users with matching channel names. If no match was found, the array is empty. Users are sorted in ascending order according to the match quality, with the first user having the best match.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.
