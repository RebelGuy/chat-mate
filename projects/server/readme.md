The Server is responsible for fetching data from Youtube via the `masterchat` project, and from Twitch via the `@twurple` package. It exposes this chat data, as well as additional functionality, via a REST API. This document is a technical overview, for an explanation of concepts refer to [`concepts.md`](../../docs/concepts.md).

# Project Details
Built JavaScript files live in the `./dist` folder, while generated data (e.g. logs) live in the `./data` folder.

## Deployments
- [Local](http://localhost:3010)
- [Sandbox](https://chat-mate-sandbox.azurewebsites.net)
- [Production](https://chat-mate-prod.azurewebsites.net)

## Scripts for development
1. `yarn install`
2. `yarn generate` to generate the Prisma client
3. `yarn auth:youtube:<local|debug|release>` to refresh the ChatMate YouTube channel's authentication credentials (has to be done once per month)
4. `yarn watch:check` to build the code using `ts-loader` (checks types)
  - Use `yarn watch:check SKIP_TESTS=true` to not include test files in the build process
  - For faster development, you can use `swc` to skip type checking while bundling up the Javascript (about 4 times faster) by running `yarn watch`
    - This does not emit source maps: debugging within VSCode will not work
5. `yarn start:local` to run the server locally, or `yarn start:mock` to use fake implementations of controllers, where available.

## Authentication
This refers specifically to authentication of the ChatMate channel. While some functions such as fetching chat do not require ChatMate to be authenticated, other functions such as banning or timing out viewers do require authentication.

### YouTube
Each environment is associated with a ChatMate channel (see [here](../../readme.md#chatmate-admin-channels) for channel details). For testing, it is acceptable to use a different channel by changing the `CHANNEL_ID` [environment variable](#env).

To complete authentication, run `yarn auth:youtube:<local|debug|release>` and log in using the account from which ChatMate should make requests. The access token will automatically be stored in the database (`youtube_auth` table) against the channel ID. Note that any changes will only come into effect when the Server is next restarted.

If the Server receives a "Rate limit exceeded" error when fetching video metadata, then Youtube has flagged us as a bot. You will need to manually log into the YouTube account again, prove you are not a bot, and then refresh the authentication token using the above command.

### Twitch
Enure you create an application on the [Twitch Developer Console](https://dev.twitch.tv/console/apps). Note down the application ID and secret and set the `TWITCH_CLIENT_ID`, `TWITCH_CLIENT_SECRET`, and `TWITCH_USERNAME` [environment variables](#env). There should be a separate application for the `release`, `debug`, and `local` environments.

When running the Server for the first time, it will be placed into "maintenance mode". This means that the ChatMate Twitch application has not yet been authorised to use App Tokens. You will need to complete authentication in Studio, under the Twitch Admin Login section, and authenticate your application using the Twitch account associated with the `TWITCH_USERNAME` environment variable. Once completed, the server will require a restart.

Important: The application scope is hardcoded in [`constants.ts`](./constants.ts) at the moment. Making any changes to the scope will require that you repeat the authentication process described above.

## Logging
When deployed, we use Application Insights to track all error and warning messages via the Trace event.

At all times, we are logging all messages to the file system. On Azure, the data folder lives under `/site/data` and can be accessed via FileZilla.

## Local EventSub
Twitch's EventSub notifies us of new events via a webhook. To [set up the listener locally](https://twurple.js.org/docs/getting-data/eventsub/listener-setup.html), we use [`ngrok`](https://ngrok.com/download). If you get an `EACCESS` error on Linux when the local server is starting up, right click the `/dist/bin/ngrok` file and, in the Permissions tab, ensure you are allowing the file to be executed as a program.

You will need to create an ngrok account, retrieve an auth token from https://dashboard.ngrok.com/get-started/your-authtoken, and set it as the `NGROK_AUTH_TOKEN` environment variable.

An SSL certificate for use by the Twitch EventSub can be generated by opening a git terminal and running the command `openssl req -newkey rsa:2048 -nodes -keyout key.pem -x509 -days 365 -out certificate.pem`.

Note: Importing modules from Twurple must be done from the package level, `@twurple/<package-name>`, rather than `@twurple/<package-name>/lib` (unfortunately VSCode defaults to this type of importing, which will result in a runtime error). 

# .env
Define `local.env`, `debug.env` and `release.env` files that set the following environment variables, one per line, in the format `KEY=value`. The `template.env` file can be used as a template. **On Azure, these variables must be set manually in the app service's configuration.**

The following environment variables must be set in the `.env` file:
- `PORT`: Which port the server should run on.
- `STUDIO_URL`: The URL to ChatMate Studio (not ending in `/`).
- `CHAT_MATE_REGISTERED_USER_NAME`: The registered username of the official ChatMate account.
- `YOUTUBE_CLIENT_ID`: The client ID for the YouTube ChatMate app (from https://console.cloud.google.com/apis/credentials).
- `YOUTUBE_CLIENT_SECRET`: The client secret for the YouTube ChatMate app.
- `CHANNEL_ID`: The channel ID of the user on behalf of which ChatMate will communicate with YouTube. If this is ever changed, you will need to re-authenticate and purge all Context Tokens from the `chat_message` table.
- `TWITCH_CLIENT_ID`: The client ID for Twitch auth (from https://dev.twitch.tv/console/apps).
- `TWITCH_CLIENT_SECRET`: The client secret for Twitch auth.
- `TWITCH_USERNAME`: The channel name of the ChatMate Twitch account. This will be used to connect to streamers' chat rooms and perform moderation operations.
- `STREAMLABS_ACCESS_TOKEN`: [currently unused] The access token for the Streamlabs account associated with the broadcaster's account. It can be found at https://streamlabs.com/dashboard#/settings/api-settings
- `DATABASE_URL`: The connection string to the MySQL database that Prisma should use. **Please ensure you append `?pool_timeout=30&connect_timeout=30` to the connection string (after the database name)** to prevent timeouts during busy times. More options can be found at https://www.prisma.io/docs/concepts/database-connectors/mysql
  - The local database connection string for the debug database is `mysql://root:root@localhost:3306/chat_mate_debug?connection_limit=5&pool_timeout=30&connect_timeout=30`
  - The remote database connection string for the debug database is `mysql://chatmateadmin:{{password}}@chat-mate.mysql.database.azure.com:3306/chat_mate_debug?connection_limit=5&pool_timeout=30&connect_timeout=30`
- `DB_LOG_LEVEL`: [Optional, defaults to `info`] The minimum log level to include for database logs. Must be either `full`, `error`, `warning`, `info`, or `disable`. For the allowed levels, the type of logging that will occur is set for each level individually via the other environment variables below.
- `API_LOG_LEVEL`: [Optional, defaults to `warning`] The minimum log level to include for API logs. Must be either `full`, `error`, `warning`, `info`, or `disable`. For the allowed levels, the type of logging that will occur is set for each level individually via the other environment variables below.
- `DEBUG_LOG_OUTPUT`: [Optional, defaults to `disable`] The log output method for debug messages. A value of `full` logs the message to the console and file, `file` logs the message to the file only, and `disable` skips logging the message.
- `INFO_LOG_OUTPUT`: [Optional, defaults to `full`] The log output method for info messages. A value of `full` logs the message to the console and file, `file` logs the message to the file only, and `disable` skips logging the message.
- `WARNING_LOG_OUTPUT`: [Optional, defaults to `full`] The log output method for warning messages. A value of `full` logs the message to the console and file, `file` logs the message to the file only, and `disable` skips logging the message.
- `ERROR_LOG_OUTPUT`: [Optional, defaults to `full`] The log output method for error messages. A value of `full` logs the message to the console and file, `file` logs the message to the file only, and `disable` skips logging the message.
- `DB_SEMAPHORE_CONCURRENT`: [Optional, defaults to `1000`] How many concurrent database requests to allow, before queuing any new requests. Note that operations on the Prisma Client generate many direct database requests, so this number shouldn't be too low (> 50).
- `DB_SEMAPHORE_TIMEOUT`: [Optional, defaults to `null`] The maximum number of milliseconds that a database request can be queued before timing it out. If null, does not timeout requests in the queue.
- `DB_TRANSACTION_TIMEOUT`: [Optional, defaults to `5000`] The maximum number of milliseconds a Prisma transaction can run before being cancelled and rolled back.
- `DB_SLOW_QUERY_THRESHOLD`: [Optional, defaults to `10000`] The threshold in milliseconds at which database queries are considered to be slow and will be logged as such.

The following environment variables are available only for **local development** (that is, where `NODE_ENV`=`local`):
- `NGROK_AUTH_TOKEN`: The ngrok auth token retrieved at https://dashboard.ngrok.com/get-started/your-authtoken. It is required to be able to listen to Twitch events locally.
- `USE_FAKE_CONTROLLERS`: [Optional, defaults to `false`] If true, replaces some controllers with test-only implementations that generate fake data. This also disables communication with external APIs (that is, it is run entirely offline).

The following environmnet variables are available only for **deployed instances** (that is, where `NODE_ENV`=`debug` || `NODE_ENV`=`release`):
- `APPLICATIONINSIGHTS_CONNECTION_STRING`: The connection string to use for connecting to the Azure Application Insights service. *This is set automatically by Azure.*
- `HOST_NAME`: The host name at which the deployed server is reachable, e.g. `example.com`. *This is set automatically by Azure.*

In addition, the following environment variables must be injected into the node instance using the `cross-env` package:
- `NODE_ENV`: Either `local`, `debug` or `release` to indicate which servers we are connecting to. Some behaviour is different when running the server locally than when the server is deployed.

Finally, the following environment variables must be present in the `<local|debug|release>.env` file when building via webpack. These are not checked at runtime, and ommitting them leads to undefined behaviour. *Note: if you change these, you need to update the `build-and-deploy.yml` file and ensure the new variables are inserted into the `.env` file.*
- `NAME`: A unique name to give this build.

For testing, define a `test.env` file that sets only a subset of the above variables:
- `DATABASE_URL`

## Database

The `local` and `debug` MySQL database is named `chat_mate_debug`, while the `release` database is named `chat_mate`, and the `test` databases are named `chat_mate_test` and `chat_mate_test_debug`. Ensure the `DATABASE_URL` connection string is set in the respective [`.env`](#env) file.

`Prisma` is used as both the ORM and typesafe interface to manage communications with the underlying MySQL database. Run `yarn migrate:debug` to sync the local DB with the checked-out migrations and generate an up-to-date Prisma Client.

At any point where the prisma file (`prisma.schema` - the database schema) is modified, `yarn generate` can be run to immediately regenerate the Prisma Client for up-to-date typings. This should also be run if the project structure changes in some way. No actual database changes are performed as part of this command. For more help and examples with using the Prisma Client and querying, refer to the [Prisma docs](https://www.prisma.io/docs/concepts/components/prisma-client).

### Migrations
Run `yarn migrate:schema` to generate a new `migration.sql` file for updating the MySQL database, which will automatically be opened for editing. Note that while this migration is not applied, any earlier unapplied migrations will be executed prior to generating the new migration. All outstanding migrations can be applied explicitly, and a new Prisma Client generated, using `yarn migrate:apply`.

During a migration, ensure that the `.sql` is checked and edited to avoid data loss. Any schema changes in the `.sql` file should exactly correspond to the schema changes in the `schema.prisma` file.

Migrations are autoamtically run in CI during the deployment process. This occurs during the last step before deployment, but it is still possible that something goes wrong where the migration succeeds, but deployment fails. For this reason, migrations should follow an expand and contract pattern.

### Debugging Slow Queries
If the CPU usage of the MySQL Server instance is consistently high, follow these steps:

- Log into MySQL.
  
  `> mysql -h chat-mate.mysql.database.azure.com -u chatmateadmin -p`

- Show all currently running processes. This includes any raw SQL queries currently executing. Running this command a few times will reveal which queries in particular need attention, as they may be listed frequently.
  
  `mysql> SHOW FULL PROCESSLIST;`

Also ensure `slow_query_logs` are enabled via the Server Parameters sidebar menu. Once enabled, you can read these from the Server Logs section or perform additional debugging in Workbook -> Query Performance Insight.

For more info, refer to https://learn.microsoft.com/en-us/azure/mysql/single-server/how-to-troubleshoot-high-cpu-utilization.

### Exporting/Importing

If importing a dump into the DigitalOcean database incurrs a permission error (code 1227), you will need to edit the dump .sql file manually:
- Remove any `DEFINER` statements, e.g. `/* DEFINER=... */`
- Remove any `@@SESSION.` statements
- Remove any `@@GLOBAL.` statements

If doing a whole-db export, it is likely that you will have to additionally export the `custom_emoji_version` table separately to prevent the image blob data from corrupting (possibly due to an encoding error).

## Punishments
Punishments are used to temporarily or permanently hide users' livestream messages. Any punishment can be revoked at any time. Punishment reasons and revoke reasons are supported but optional. Punishments can be either temporary or permanent, depending on the type.

Currently there are 3 punishment types:
1. `mute`: This is an internal punishment, and is used by the Client to hide messages of a certain user. A mute can be temporary or permanent.
2. `timeout`: This is both internal and external (i.e. sent to YouTube and Twitch) and completely stops the user from sending messages in the livestream chat. It is always temporary. Due to limitations with the Youtube API, timeouts must be at most 1 day long.
3. `ban`: This is essentially a permanent timeout.

## Testing
`yarn test` performs the test suite.
`yarn test:db` Sets up the test database (i.e. by applying migrations, if required).
`yarn test <file regex>` includes only tests within files matching the expression.

Further, to filter individual tests, temporarily replace `test()` with `test.only()`. All other `test()`s will then be skipped.

Due to concurrency issues, all tests using the test database will need to be run from the central `_test/stores.test.ts` file. It imports the `<StoreName>.suite.ts` files which contain the actual tests, then run them one-by-one. Store tests are not currently performed as part of the CI build due to timing issues (locally, with minimal latency, they already take ~40 minutes (no joke, wtf)).

## Stores
Stores are classes that abstract away direct interactions with the database via Prisma to segragate the testing of business logic and data access. Integration tests involving the live testing database must be defined in `stores.tests.ts` instead of their individual files to guarantee that they are run in series.

The number of concurrent queries that the database allows is limited, and there is some latency when communicating between the server and database (on the order of 10-20 ms, it seems). Preferrably, Prisma queries should return collections of results instead of individual results, so that aggregation of data is done directly on the database to reduce the number of queries and improve performance.

For example, instead of allowing getting the experience for only a specific user and thus forcing multiple queries to get the experience of multiple users, write the store method in such a way that only a single query is required to get the experience of multiple users. Due to limitations with the Prisma ORM capabilities, this may require the use of raw SQL queries.

# API Endpoints
Use the API endpoints to communicate with the server while it is running. The local API base URL is `http://localhost:3010/api`.

Every response contains the following properties:
- `timestamp` (`number`): The unix timestamp (in ms) at which the response was generated.
- `success` (`boolean`): True if the request was processed correctly, and false otherwise.
- `data` (`object`): Only included if `success` is `true`. Contains the response data, outlined for each endpoint below.
- `error` (`object`): Only included if `success` is `false`. Contains the following properties:
  - `errorCode` (`number`): The HTTP error code that most closely matches the type of problem encountered.
  - `errorType` (`string`): The general type of error encounterd.
  - `internalErrorType` (`string`): The internal error type that was encountered, for example, the name of the CustomError classes in `/projects/shared/util/error.ts`.
  - `message` (`string`): An optional error message describing what went wrong.

Note that a `500` error can be expected for all endpoints and a `401` error for endpoints requiring authentication, but any other errors should be documented specifically in the below sections.

All non-primitive properties of `data` are of type `PublicObject`, which are reusable objects which themselves contain either primitive types or other `PublicObject`s. The definitions for these objects can be found in the [`/projects/api-models/public`](https://github.com/RebelGuy/chat-mate/tree/master/projects/api-models/public) folder and will not be reproduced here. Please ensure the Client's model is in sync at all times.

Authentication is required for most endpoints. To authenticate a request, provide the login token returned by the `/account/register` or `/account/login` endpoints, and add it to requests via the `X-Login-Token` header.

Any streamer-specific endpoints require the `X-Streamer` header. This should be set to the streamer's registered username for which the request should be made (for example, when getting custom emojis).

## Account Endpoints
Path: `/account`.

### `POST /register` [anonymous]
Registers a new user.

Request data (body):
- `username` (`string`): *Required.* The username for which to register a new account.
- `password` (`string`): *Required.* The password that will be used to log the user in.

Returns data with the following properties:
- `loginToken` (`string`): A token used to authenticate the user when making another API request.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `POST /login` [anonymous]
Logs the user into their account.

Request data (body):
- `username` (`string`): *Required.* The username of the account to log into.
- `password` (`string`): *Required.* The password of the account to log into.

Returns data with the following properties:
- `loginToken` (`string`): A token used to authenticate the user when making another API request.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.
- `401`: When the credentials are incorrect.

### `POST /logout`
Logs the user out of their account by invalidating all login tokens. To authenticate, the user must call `/login` again.

Returns an empty response body.

### `POST /authenticate`
Authenticates the login token contained in the header. If successful, the login token can be used to authenticate other API requests.

Returns data with the following properties:
- `username` (`string`): The username associated with the login token.

Can return the following errors:
- `401`: When the login token is invalid.

## Admin Endpoints
Path: `/admin`.

### `GET /administrativeMode`
Returns whether the Server is currently in administrative mode. If true, Twitch communication is disabled and must be re-authenticated.

Returns data with the following properties:
- `isAdministrativeMode` (`boolean`): Whether we are currently in administrative mode.

### `GET /twitch/login`
Retrieves the Twitch login URL that should be used to start the OAuth2 authorisation flow. Intended to be used by Studio. See [the docs](../../docs/twitch-auth.md) for more info.

Returns data with the following properties:
- `url` (`string`): The login URL. It will redirect back to Studio.
- `twitchUsername` (`string`): The username of the ChatMate Twitch account. This account must be used to authenticate on the admin page.

### `POST /twitch/authorise`
Authorises the authorisation code and updates the stored Twitch `access_token` in the database.

Query parameters:
- `code` (`string`): The authorisation code obtained from Twitch after logging on.

Returns an empty response body.

### `POST /twitch/reconnectChatClient`
Reconnects the Twitch chat client. Note that this will have no effect if the stored access/refresh token was previously revoked - in this case, the server must be restarted since the token is retrieved and set at startup.

Returns an empty response body.

### `POST /twitch/resetSubscriptions`
Deletes and re-initialises all streamer event subscriptions.

Returns an empty response body.

### `GET /youtube/login`
Retrieves the Youtube login URL that should be used to start the OAuth2 authorisation flow. Intended to be used by Studio. See [the docs](../../docs/youtube-auth.md) for more info.

Returns data with the following properties:
- `url` (`string`): The login URL. It will redirect back to Studio.
- `youtubeChannelName` (`string`): The channel name of the ChatMate Youtube account. This account must be used to authenticate on the admin page.

### `POST /youtube/authorise`
Authorises the authorisation code and updates the stored Youtube `access_token` in the database.

Query parameters:
- `code` (`string`): The authorisation code obtained from Youtube after logging on.

Returns an empty response body.

### `POST /youtube/revoke`
Revokes the ChatMate authorisation for the admin's Youtube channel.

Returns an empty response body.

### `GET /link/logs`
Gets the list of all link attempt logs.

Returns data with the following properties:
- `logs` (`PublicLinkAttemptLog[]`): The list of link attempt logs.

### `POST /link/release`
Releases a failed link attempt, acknowledging that any further link attempts are able to go ahead safely.

Query parameters:
- `linkAttemptId` (`number`): *Required.* The id of the link attempt that is to be released.

Returns an empty response body.

## Chat Endpoints
Path: `/chat`.

### `GET`
Retrieves the latest chat items.

Query parameters:
- `since` (`number`): *Optional.* Gets only chat items **after** the given time (unix ms).
- `limit` (`number`): *Optional.* Limits the number of returned chat items. Defaults to the maximum value of 100.

Returns data with the following properties:
- `reusableTimestamp` (`number`): The timestamp of the latest chat item. Use this value as the `since` query parameter in the next request for continuous data flow (no duplicates).
- `chat` (`PublicChatItem[]`): The chat data that satisfy the request filter, sorted in ascending order by time.

### `GET /command/:commandId`
Gets the current status of the specified command.

Path parameters:
- `commandId` (`number`): The ID of the command for which to get the status.

Returns data with the following properties:
- `status` (`string`): The current status of the command.
  - `'success'`: The command executed successfully.
  - `'error'`: The command encountered an error during execution.
  - `'pending'`: The command has not yet finished executing.
- `message` (`string | null`): The success or error message of the executed command. Only set if `status` is `'success'` or `'error'`.
- `durationMs` (`number | null`): The number of milliseconds taken to execute the command. Only set if `status` is `'success'` or `'error'`.

Can return the following errors:
- `400`: When the required parameters have not been provided.
- `404`: When the specified command was not found.

## ChatMate Endpoints
Path: `/chatMate`.

### `GET /ping` [anonymous]
Pings the server.

Returns data with no properties.

### `GET /masterchat/authentication`
Check whether the currently active Masterchat instance is authenticated.

Returns data with the following properties:
- `authenticated` (`boolean | null`): Whether the Masterchat instance is authenticated.
  - `true`: The Masterchat instance is authenticated.
  - `false`: The Masterchat instance is not authenticated. This could be because the provided credentials are invalid, or have expired. Actions requiring a logged-in user will fail (e.g. livestream moderation).
  - `null`: Unknown - no Masterchat instance is active, or authentication has not been verified yet.

### `GET /username`
Gets the username of the official ChatMate registered account.

Returns data with the following properties:
- `username` (`string`): The username of the registered account.

## Donation Endpoints
Path: `/donation`.

### `GET /`
Gets all donations, including refunded donations.

Returns data with the following properties:
- `donations` (`PublicDonation[]`): The list of all donations.

### `POST /`
Manually create a new donation.

Request data (body):
- `amount` (`number`): *Required.* The username of the account to log into.
- `currencyCode` (`string`): *Required.* The currency code for the donation. Must be a valid code returned by the [`GET /currencies` endpoint](#get-currencies).
- `name` (`string`): *Required.* The display name of the donator.
- `message` (`string`): *Optional.* The raw donation message.

Returns data with the following properties:
- `newDonation` (`PublicDonation`): The newly created donation.

Can return the following errors:
- `400`: When the request data is not sent or formatted incorrectly.

### `DELETE /`
Deletes a donation. Deleted donations are not returned by any other donation endpoints.

Query parameters:
- `donationId` (`number`): The ID of the donation to mark as refunded.

Returns an empty body.

Can return the following errors:
- `400`: When the request data is not sent.
- `404`: When no donation was found for the given ID.

### `GET /currencies`
Gets the list of currencies that can be used when creating a new donation manually.

Returns data with the following properties:
- `currencies` (`PublicCurrency[]`): The list of supported currencies.

### `POST /link`
Links a user to a donation.

Query parameters:
- `donationId` (`number`): The ID of the donation to which the user should be linked.
- `userId` (`number`): The user to link to the donation.

Returns data with the following properties:
- `updatedDonation` (`PublicDonation`): The updated donation that now includes the linked user.

Can return the following errors:
- `400`: When the request data is not sent, or when a user is already linked to the given donation.
- `404`: When no donation was found for the given ID.

### `DELETE /link`
Unlinks a user to a donation.

Query parameters:
- `donationId` (`number`): The ID of the donation from which the user should be unlinked.

Returns data with the following properties:
- `updatedDonation` (`PublicDonation`): The updated donation that no longer includes the linked user.

Can return the following errors:
- `400`: When the request data is not sent, or when no user was linked to the given donation.
- `404`: When no donation was found for the given ID.

### `POST /refund`
Marks the donation as being refunded.

Query parameters:
- `donationId` (`number`): The ID of the donation to mark as refunded.

Returns data with the following properties:
- `updatedDonation` (`PublicDonation`): The updated donation that is now marked as refunded.

Can return the following errors:
- `400`: When the request data is not sent or when the donation is already marked as refunded.
- `404`: When no donation was found for the given ID.

### `POST /streamlabs/socketToken`
Sets the streamlab socket token for listening to the current streamer's donations. The server is unable to get donations if the token is not set, or is invalid.

Request data (body):
- `websocketToken` (`string | null`): The streamlabs socket token to use. It can be found at https://streamlabs.com/dashboard#/settings/api-settings. If set, the server will immediately start listening to donations. If `null`, the server will stop listening to donations (if applicable).

Returns data with the following properties:
- `result` (`string`): The result of applying the specified socket token.
  - Set to `success` if the operation was successful and resulted in a state change.
  - Set to `noChange` if the operation was successful, but the provided token was the same as the existing token and thus no state change occurred.

### `GET /streamlabs/status`
Gets the Streamlabs donation WebSocket status.

Returns data with the following properties:
- `status` (`string`): The status of the current streamer's donation WebSocket.
  - Set to `notListening` if we are not currently listening to donations. This is most likely because no socket token has been set by the streamer.
  - Set to `listening` if we are currently listening to donations.
  - Set to `error` if something went wrong. We are most likely not listening to donations, and it is recommended that the socket token be reset.

## Emoji Endpoints
Path: `/emoji`.

### `GET /custom`
Gets all custom emojis.

Returns data with the following properties:
- `emojis` (`PublicCustomEmoji[]`): The list of all custom emojis.

### `POST /custom`
Add a new custom emoji.

Request data (body):
- `newEmoji` (`PublicCustomEmojiNew`): *Required.* The new emoji's data. Note that the `symbol` must be unique, otherwise the request will get rejected.

Returns data with the following properties:
- `newEmoji` (`PublicCustomEmoji`): The new emoji that was created.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `PATCH /custom`
Update an existing custom emoji.

Request data (body):
- `updatedEmoji` (`PublicCustomEmoji`): *Required.* The updated emoji's data. Note that the `symbol` must be unique, otherwise the request will get rejected. The `id` is used to match the new emoji to an emoji in the database.

Returns data with the following properties:
- `updatedEmoji` (`PublicCustomEmoji`): The updated emoji data.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

## Experience Endpoints
Path: `/experience`.

### `GET /leaderboard`
Gets the ranked experience list of all users.

Returns data with the following properties:
- `rankedUsers` (`PublicRankedUser[]`): The array of every user's rank, sorted in ascending order.

### `GET /rank`
Gets the rank of a specific user, as well as some context. Essentially, it returns a sub-section of the data from `GET /leaderboard`.

Query parameters:
- `id` (`number`): *Required.* The id of the user for which the rank is to be returned.

Returns data with the following properties:
- `relevantIndex` (`number`): The index of the entry in `entries` that belongs to the matched channel. Never negative.
- `rankedUsers` (`PublicRankedUser[]`): The partial leaderboard in ascending order, which includes the matched channel. Never empty.

Can return the following errors:
- `400`: When the required query parameters have not been provided.
- `404`: When no channel could be matched against the search query.

### `POST /modify`
Modifies a player's experience by adding a special admin transaction.

Request data (body):
- `userId` (`int`): *Required.* The user whose experience should be modified.
- `deltaLevels` (`float`): *Required.* How many levels to add or take away. This can be a fractional value. A user's current fractional level is given by `levelInfo.level + levelInfo.levelProgress`.
  message: (`string`): *Optional.* A custom message to add as part of the transaction.

Returns data with the following properties:
- `updatedUser` (`PublicUser`): The user object after the experience change has been applied.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.
- `404`: When the given user is not found.

## Livestream Endpoints
Path: `/livestream`.

### `GET /`
Gets the list of all livestreams with any status.

Returns data with the following properties:
- `youtubeLivestreams` (`PublicLivestream[]`): The list of Youtube livestreams, sorted by start time in ascending order. Livestreams that haven't started yet are placed at the end of the array.
- `twitchLivestreams` (`PublicLivestream[]`): The list of Twitch livestreams, sorted by start time in ascending order.
- `aggregateLivestreams` (`PublicAggregateLivestream[]`): The list of aggregate livestreams, sorted by start time in ascending order. An aggregate livestream is a logical period of time during which the streamer was live on either platform. No two aggregate livestreams overlap. Only the last aggregate livestream in the list may still be ongoing.

## Punishment Endpoints
Path: `/punishment`.

### `GET /:id`
Gets a punishment by id.

Path parameters:
- `id` (`number`): *Required.* The ID of the punishment to retrieve.

Returns data with the following properties:
- `punishment` (`PublicUserRank`): The punishment matching the specified id.

Can return the following errors:
- `404`: When a punishment with the specifed id could not be found.

### `GET`
Gets the list of current or historical punishments.

Query parameters:
- `userId` (`number`): *Required if `includeInactive` is `true`, otherwise optional.* The ID of the user for which to get the punishment list. If not provided, returns active punishments for all users.
- `includeInactive` (`boolean`): *Optional.* If true, returns the list of historical punishments (active and inactive) for a user. If false, returns punishments that are currently active, either for all users or the provided user.

Returns data with the following properties:
- `punishments` (`PublicUserRank[]`): The list of punishments of the user, in descending order by time issued.

Can return the following errors:
- `400`: When the required query parameters have not been provided, or the query parameters are incompatible.

### `POST /ban`
Applies a punishment of type `ban` to the user, which is essentially a permanent `timeout`. This endpoint may also be used to apply bans to any channels which may not currently be banned.

Request data (body):
- `userId` (`int`): *Required.* The primary user to which the punishment should be applied.
- `message` (`string`): *Optional.* The reason for the punishment.

Returns data with the following properties:
- `newPunishment` (`PublicUserRank | null`): The new punishment that was created as a result of this request, if successful.
- `newPunishmentError` (`string | null`): If `newPunishment` is `null`, the error that was encountered when attempting to add the punishment.
- `channelPunishments` (`PublicChannelRankChanges[]`): The external punishments applied to channels on YouTube or Twitch.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `POST /unban`
Revokes an existing `ban` punishment from the user. This may also be used to remove any residual bans on the external platforms.

Request data (body):
- `userId` (`int`): *Required.* The user from which the punishment should be revoked.
- `message` (`string`): *Optional.* The reason for revoking the punishment.

Returns data with the following properties:
- `removedPunishment` (`PublicUserRank | null`): The punishment that was removed, if successful.
- `removedPunishmentError` (`string | null`): If `removedPunishment` is `null`, the error that was encountered when attempting to remove the punishment.
- `channelPunishments` (`PublicChannelRankChanges[]`): The external punishments revoked from channels on YouTube or Twitch. Note that these are executed regardless of whether an internal punishment was found or not.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `POST /timeout`
Applies a punishment of type `timeout` to the user, which is essentially a temporary `ban`. This endpoint may also be used to apply timeouts to any channels which may not currently be timed out.

Request data (body):
- `userId` (`int`): *Required.* The user to which the punishment should be applied.
- `message` (`string`): *Optional.* The reason for the punishment.
- `durationSeconds` (`number`): *Required.* The duration of the punishment, in seconds. Must be at least 1 second and at most 1 day.

Returns data with the following properties:
- `newPunishment` (`PublicUserRank | null`): The new punishment that was created as a result of this request, if successful.
- `newPunishmentError` (`string | null`): If `newPunishment` is `null`, the error that was encountered when attempting to add the punishment.
- `channelPunishments` (`PublicChannelRankChanges[]`): The external punishments applied to channels on YouTube or Twitch.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `POST /revokeTimeout`
Revokes an existing `timeout` punishment from the user. This may also be used to remove any residual timeouts on the external platforms.

Request data (body):
- `userId` (`int`): *Required.* The user from which the punishment should be revoked.
- `message` (`string`): *Optional.* The reason for revoking the punishment.

Returns data with the following properties:
- `removedPunishment` (`PublicUserRank | null`): The punishment that was removed, if successful.
- `removedPunishmentError` (`string | null`): If `removedPunishment` is `null`, the error that was encountered when attempting to remove the punishment.
- `channelPunishments` (`PublicChannelPunishment[]`): The external punishments revoked from channels on YouTube or Twitch. Note that these are executed regardless of whether an internal punishment was found or not.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `POST /mute`
Applies a punishment of type `mute` to the user.

Request data (body):
- `userId` (`int`): *Required.* The user to which the punishment should be applied.
- `message` (`string`): *Optional.* The reason for the punishment.
- `durationSeconds` (`number`): *Optional.* The duration of the punishment, in seconds. If 0 or not provided, the punishment is permanent.

Returns data with the following properties:
- `newPunishment` (`PublicUserRank`): The new punishment that was created as a result of this request.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly. This error is also returned when a mute is already active for the given user.

### `POST /unmute`
Revokes an existing `mute` punishment from the user.

Request data (body):
- `userId` (`int`): *Required.* The user from which the punishment should be revoked.
- `message` (`string`): *Optional.* The reason for revoking the punishment.

Returns data with the following properties:
- `removedPunishment` (`PublicUserRank`): The rank that was removed.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.
- `404`: When an active mute was not found for the given user.


## Rank Endpoints
Path: `/rank`.

Note: For punishment-specific functionality, refer to the [punishment endpoints](#punishment-endpoints).

### `GET`
Gets the list of current or historical user-ranks. If the streamer header is provided, returns ranks for the streamer and global ranks, otherwise returns global ranks only.

Query parameters:
- `userId` (`number`): *Optional.* The ID of the user for which to get the list of ranks. Defaults to the logged-in user.
- `includeInactive` (`boolean`): *Optional.* If true, returns the list of historical ranks (active and inactive) for a user. If false, returns only ranks that are currently active.

Returns data with the following properties:
- `ranks` (`PublicUserRank[]`): The list of ranks of the user, in descending order by time issued.

Can return the following errors:
- `400`: When the required query parameters have not been provided.

### `GET /accessible`
Gets the ranks accessible to the current user. At the moment, it returns all Regular ranks and Punishment ranks.

Returns data with the following properties:
- `accessibleRanks` (`PublicRank[]`): The list of ranks accessible to the user.

### `POST`
Adds a Regular rank to the specified user.

Request data (body):
- `rank` (`string`): *Required.* The name of the rank to add. Should be one of the following: `famous`, `donator`, `supporter`, `member`.
- `userId` (`int`): *Required.* The user to which the rank should be added.
- `message` (`string`): *Optional.* A custom message to accompany the rank addition.
- `durationSeconds` (`number`): *Optional.* The duration of the rank, in seconds, after which it should automatically expire. If 0 or not provided, the rank is permanent.

Returns data with the following properties:
- `newRank` (`PublicUserRank`): The new user-rank that was added.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly. This error is also returned when a rank of the specified type is already active for the given user.

### `DELETE`
Removes a regular rank from the specified user.

Request data (body):
- `rank` (`string`): *Required.* The name of the rank to remove. Should be one of the following: `famous`, `donator`, `supporter`, `member`.
- `userId` (`int`): *Required.* The user from which the rank should be removed.
- `message` (`string`): *Optional.* A custom message to accompany the rank removal.

Returns data with the following properties:
- `removedRank` (`PublicUserRank`): The rank that was removed.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.
- `404`: When an active rank of the specified type was not found for the given user.

### `POST /mod`
Add the `mod` rank to the specified user.

Request data (body):
- `userId` (`int`): *Required.* The user to which the rank should be added.
- `message` (`string`): *Optional.* A custom message to accompany the rank addition.

Returns data with the following properties:
- `newRank` (`PublicUserRank | null`): The new rank that was added, if successful.
- `newRankError` (`string | null`): If `newRank` is `null`, the error that was encountered when attempting to add the rank.
- `channelModChanges` (`PublicChannelRankChange[]`): The external updates made to channels on YouTube or Twitch.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `DELETE /mod`
Remove the `mod` rank from the specified user.

Request data (body):
- `userId` (`int`): *Required.* The user from which the rank should be removed.
- `message` (`string`): *Optional.* A custom message to accompany the rank removal.

Returns data with the following properties:
- `removedRank` (`PublicUserRank | null`): The rank that was removed, if successful.
- `removedRankError` (`string | null`): If `removedRank` is `null`, the error that was encountered when attempting to remove the rank.
- `channelModChanges` (`PublicChannelRankChange[]`): The external updates made to channels on YouTube or Twitch.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `GET /customise`
Gets the list of ranks whose name can be customised by users.

Returns data with the following properties:
- `customisableRanks` (`PublicRank[]`): The list of ranks whose name can be customised.

### `POST /customise`
Adds a custom rank name or updates an existing one. Custom ranks will apply only in the context of the current streamer.

Request data (body):
- `rank` (`string)`: *Required.* The rank whose name to customise. Must be one of the ranks returned by the [`GET /customise`](#get-customise) endpoint.
- `name` (`string`): *Required.* The name of the rank. If the rank has already been named previously, the old name will be overwritten.
- `isActive` (`boolean`): *Optional.* Whether the custom rank name is currently active or not.

Returns an empty body.

Can return the following errors:
- `400`: When the request data is not sent or is formatted incorrectly, or when the provided name is invalid.

### `DELETE /customise`
Deletes a custom rank name in the context of the current streamer.

Query parameters:
- `rank` (`string`): *Required.* The rank whoe custom name should be deleted.

Returns an empty body.

Can return the following errors:
- `404`: When a custom name for the given rank was not found in the context of the current streamer.

## Streamer Endpoints
Path: `/streamer`.

### `GET`
Gets all streamer data in ChatMate.

Returns data with the following properties:
- `streamers` (`PublicStreamerSummary[]`): The array of streamer data.

### `GET /application`
Gets all streamer applications of the user. If the user is an admin, returns all applications of all users.

Returns data with the following properties:
- `streamerApplications` (`PublicStreamerApplication[]`): The array of streamer applications with any status.

### `POST /application`
Creates a new streamer application for the user.

Request data (body):
- `message` (`string`): *Required.* The user-defined message to include in the application.

Returns data with the following properties:
- `newApplication` (`PublicStreamerApplication`): The streamer application that was created.

### `POST /application/:streamerApplicationId/approve`
Approves a pending streamer application.

Path parameters:
- `streamerApplicationId` (`number`): *Required.* The ID of the streamer application to approve.

Request data (body):
- `message` (`string`): *Required.* The admin-defined approval message.

Returns data with the following properties:
- `updatedApplication` (`PublicStreamerApplication`): The updated streamer application.

Can return the following errors:
- `400`: When the streamer application status was not `pending`, that is, it was already closed.

### `POST /application/:streamerApplicationId/reject`
Rejects a pending streamer application.

Path parameters:
- `streamerApplicationId` (`number`): *Required.* The ID of the streamer application to reject.

Request data (body):
- `message` (`string`): *Required.* The admin-defined rejection message.

Returns data with the following properties:
- `updatedApplication` (`PublicStreamerApplication`): The updated streamer application.

Can return the following errors:
- `400`: When the streamer application status was not `pending`, that is, it was already closed.

### `POST /application/:streamerApplicationId/withdraw`
Withdraws a pending streamer application.

Path parameters:
- `streamerApplicationId` (`number`): *Required.* The ID of the streamer application to withdraw.

Request data (body):
- `message` (`string`): *Required.* The user-defined withdrawal message.

Returns data with the following properties:
- `updatedApplication` (`PublicStreamerApplication`): The updated streamer application.

Can return the following errors:
- `400`: When the streamer application status was not `pending`, that is, it was already closed.

### `GET /primaryChannels`
Gets the logged-in streamer's primary channels, that is, the channels that they have selected to stream on.

Returns data with the following properties:
- `youtubeChannelId` (`number | null`): The internal id of the streamer's primary YouTube channel, if set.
- `twitchChannelId` (`number | null`): The internal id of the streamer's primary Twitch channel, if set.
- `twitchChannelName` (`string | null`): The Twitch channel name of the streamer's primary Twitch channel, if set.

### `POST /primaryChannels/:platform/:channelId`
Sets the streamer's primary channel for the specified platform. Note that this request will fail if a primary channel already exists.

Path parameters:
- `platform` (`string`): The platform for which to set the primary channel. Must be either `youtube` or `twitch`.
- `channelId` (`number`): The internal id of the YouTube or Twitch channel to set as the streamer's primary channel.

Returns an empty body.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.
- `403`: When the channel ID refers to a channel that the user is not linked to.

### `DELETE /primaryChannels/:platform`
Removes the streamer's primary channel for the specified platform. The request will succeed even if no primary channel is set for the platform.

Path parameters:
- `platform` (`string`): The platform from which to remove the primary channel. Must be either `youtube` or `twitch`.

Returns an empty body.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `GET /twitch/status`
Gets the list of Twitch subscription statuses.

Returns data with the following properties:
- `statuses` (`PublicTwitchEventStatus[]`): The list of statuses, one for each subscription type.

Can return the following errors:
- `403`: When the logged-in user is not a streamer.
- `404`: When no Twitch statuses were found. Most likely this is because the streamer has not set a primary Twitch channel.

### `GET /twitch/login`
Retrieves the Twitch login URL that should be used by the streamer to authorise the ChatMate Application. Intended to be used by Studio. See [the docs](../../docs/twitch-auth.md) for more info.

Returns data with the following properties:
- `url` (`string`): The login URL. It will redirect back to Studio.

Can return the following errors:
- `403`: When the logged-in user is not a streamer.

### `POST /twitch/authorise`
Authorises the authorisation code and updates the stored Twitch `access_token` in the database.

Query parameters:
- `code` (`string`): The authorisation code obtained from Twitch after logging on.

Returns an empty response body.

Can return the following errors:
- `403`: When the logged-in user is not a streamer.

### `GET /youtube/status`
Retrieves the status of the ChatMate admin YouTube channel in relation to the logged-in streamer's current primary YouTube channel. ChatMate requires that the streamer add the admin channel as a moderator. Note that we can only check the moderator status at the time of the last message received in the streamer's latest livestream.

Returns data with the following properties:
- `chatMateIsModerator` (`boolean`): Whether the ChatMate admin YouTube channel was added as a moderator to the logged-in streamer's current primary YouTube channel.
- `timestamp` (`number`): The latest time for which the moderation status could be verified. It may have changed since then.

Can return the following errors:
- `400`: When the logged-in streamer does not have a primary Youtube channel set.
- `403`: When the logged-in user is not a streamer.

### `GET /youtube/login`
Retrieves the Youtube login URL that should be used by the streamer to authorise the ChatMate Application. Intended to be used by Studio. See [the docs](../../docs/youtube-auth.md) for more info.

Returns data with the following properties:
- `url` (`string`): The login URL. It will redirect back to Studio.

Can return the following errors:
- `400`: When the logged-in user has not set a primary Youtube channel.
- `403`: When the logged-in user is not a streamer.

### `POST /youtube/authorise`
Authorises the authorisation code and updates the stored Youtube `access_token` in the database.

Query parameters:
- `code` (`string`): The authorisation code obtained from Youtube after logging on.

Returns an empty response body.

Can return the following errors:
- `400`: When the logged-in user has not set a primary Youtube channel.
- `403`: When the logged-in user is not a streamer.

### `POST /youtube/revoke`
Revokes the ChatMate authorisation for the admin's Youtube channel.

Returns an empty response body.

Can return the following errors:
- `400`: When the logged-in user has not set a primary Youtube channel.
- `403`: When the logged-in user is not a streamer.

### `GET /youtube/moderators`
Gets the list of moderator YouTube channels, as reported by YouTube.

Returns data with the following properties:
- `moderators` (`PublicYoutubeModerator[]`): The list of YouTube moderators.

Can return the following errors:
- `400`: When the logged-in user has not set a primary Youtube channel.
- `403`: When the logged-in user is not a streamer.

### `GET /status`
Gets the latest status information.

Returns data with the following properties:
- `livestreamStatus` (`PublicLivestreamStatus | null`): Status information relating to the active public livestream. Null if there is no active public livestream.
- `youtubeApiStatus` (`PublicApiStatus`): Status information relating to the YouTube API.
- `twitchApiStatus` (`PublicApiStatus`): Status information relating to the YouTube API.

### `GET /events`
Gets the events that have occurred since the specified time.

Query parameters:
- `since` (`number`): *Required.* Gets only events **after** the given time (unix ms).

Returns data with the following properties:
- `reusableTimestamp` (`number`): Use this value as the `since` query parameter in the next request for continuous data flow (no duplicates).
- `events` (`PublicChatMateEvent[]`): The list of events that have occurred since the given timestamp, sorted by time in ascending order.

Can return the following errors:
- `400`: When the required query parameters have not been provided.

### `PATCH /livestream`
Sets the active Youtube livestream. Note that an active Youtube livestream cannot be set if another one is already active. Please deactivate the existing one first (see below).

Request data (body):
- `livestream` (`string | null`): *Required.* The Youtube livestream link or id to set as active. If `null`, the active stream will be deactivated.

Returns data with the following properties:
- `livestreamLink` (`string | null`): The new Youtube livestream link.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.
- `422`: When an active Youtube livestream already exists.

## User Endpoints
Path: `/user`.

### `GET /`
Gets info about the logged-in user.

Returns data with the following properties:
- `user` (`PublicUser`): The data object of the currently logged-in user.

### `POST /search`
Search for a specific channel name.

Request data (body):
- `searchTerm` (`string`): *Required.* The string to search in user's channel names.

Returns data with the following properties:
- `results` (`PublicUserSearchResult[]`): An array containing information about matched channels. If no match was found, the array is empty. It is possible that multiple of the user's channels appear in different results.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `POST /search/registered`
Search for a specific registered user.

Request data (body):
- `searchTerm` (`string`): *Required.* The string to search in the users' registered usernames.

Returns data with the following properties:
- `results` (`PublicUserSearchResult[]`): An array containing information about matched registered users. Note that the `matchedChannel` property will always be null.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `GET /link/channels`

Gets the list of channels linked to the logged-in user.

Query parameters:
- `admin_aggregateUserId` (`number`): *Optional, admin-only.* Gets the list of channels linked to a particular user.

Returns data with the following properties:
- `registeredUser` (`PublicRegisteredUser`): The registered user to which the channels are attached.
- `channels` (`PublicChannelInfo[]`): The channels linked to the user.

### `POST /link/channels/:aggregateUserId/:defaultUserId`

Adds a link between the given default user and aggregate user.

### `DELETE /link/channels/:defaultUserId`

Removes the link between the given default user with its aggregate user.

Query parameters:
- `transferRanks` (`boolean`): *Optional.* Whether to copy the current aggregate user's ranks to the default user. Does not affect the aggregate user's ranks. Defaults to `true`.
- `relinkChatExperience` (`boolean`): *Optional.* Whether to relink back to the default user any chat experience earned by that default user before or during the current link. This will affect the aggregate user's level. Defaults to `true`.
- `relinkDonations` (`boolean`): *Optional.* Whether to relink back to the default user any donations assigned to that default user before or during the current link. Defaults to `true`.

### `GET /link/history`

Get the link history for the logged-in user.

Query parameters:
- `admin_aggregateUserId` (`number`): *Optional, admin-only.* Gets the link history for a particular user.

Returns data with the following properties:
- `items` (`PublicLinkHistoryItem[]`): The array representing the user's link history. The ordering of items is undefined.

### `POST /link/token`

Create a link token for a YouTube or Twitch channel that is connected to the logged-in account.

Path parameters:
- `externalId` (`string`): The YouTube channel ID or Twitch username of the channel.

Returns data with the following properties:
- `token` (`PublicLinkToken`): The new link token that was created or, if an unused token already existed for the specified channel, an existing token.

Can return the following errors:
- `400`: When the `externalId` is not sent.
- `404`: When no channel matching the given `externalId` could be found. The channel in question must have sent at least one chat message in the past so that it is added to our database.
- `422`: When the specified channel is already linked to a user.

### `DELETE /link/token`

Delete a pending link token that is connected to the logged-in account.

Path parameters:
- `linkToken` (`string`): The link token to delete.

Returns an empty response body.

Can return the following errors:
- `404`: When the specified pending link token is not found. For example, if it is not connected to the logged-in user, or already used as part of a link attempt.
