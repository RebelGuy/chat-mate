The server is responsible for fetching data from Youtube via the `masterchat` project, and from Twitch via the `@twurple` package. It exposes this chat data, as well as additional functionality, via a REST API.



# Project Details
Built JavaScript files live in the `./dist` folder, while generated data (e.g. logs) live in the `./data` folder.

Note: If fetching Youtube metadata incurs a "Rate limit exceeded" error, then Youtube has flagged us as a bot. A (temporary?) solution is to regenerate an auth token (see below).

Twitch's EventSub notifies us of new events via a webhook. To set up the listener on our local machine, we use `ngrok` (https://ngrok.com/download). See https://twurple.js.org/docs/getting-data/eventsub/listener-setup.html for more details.

An SSL certificate for use by the Twitch EventSub can be generated by opening a git terminal and running the command `openssl req -newkey rsa:2048 -nodes -keyout key.pem -x509 -days 365 -out certificate.pem`.

Note: Importing modules from Twurple must be done from the package level, `@twurple/<package-name>`, rather than `@twurple/<package-name>/lib` (unfortunately VSCode defaults to this type of importing, which will result in a runtime error). 


## Scripts for development:
1. `yarn install`.
2. `yarn auth` to fetch the authentication credentials for YouTube (once done, copy the token from the console and set it in the respective [`.env`](#.env) file), and `yarn auth:twitch:<local|debug|release>` to refresh Twitch authentication.
3. `yarn watch` while developing
  - This uses `swc` to bundle up the Javascript, which skips type checking for performance (about 4 times faster)
  - Rely on VSCode for checking types if using this mode
  - Use `yarn watch:check` to use `ts-loader` and enable type checking
4. `yarn start:local` to run the server locally, or `yarn start:mock` to use fake implementations of controllers, where available.

If building fails because the Prisma client could not be found, please run `yarn generate`.


## Authentication
### YouTube
Run `yarn auth` and log in using the streaming account, or a moderator account. After the Electron app closes, note the authentication token in the console and use it as the `AUTH` environment variable.

### Twitch
Enure you create an application on the [Twitch Developer Console](https://dev.twitch.tv/console/apps). Note down the application ID and secret and set the relevant environment variables. These will not change in the future. There should be a separate application for the `release`, `debug`, and `local` environments.

For the initial authentication, you will need to start the Electron app via `yarn auth:twitch:<local|debug|release>` and sign in manually with the relevant ChatMate account. The access token and refresh token will automatically be stored in the database (`twitch_auth` table) and retrieved/updated automatically thereon.

Important: The application scope is hardcoded in `TwurpleAuthProvider.ts` at the moment. Making any changes to the scope will require that you repeat the authentication process described above.

## Logging

When deployed, we use Application Insights to track all error and warning messages via the Trace event.

At all times, we are logging all messages to the file system. On Azure, the data folder lives under `/site/data` and can be accessed via FileZilla.

The retrieval of logs from Application Insights is achieved automatically (and exposed via the LogsController) using Azure's Log Analytics Workspaces and the [`monitor-query` package](https://docs.microsoft.com/en-us/javascript/api/overview/azure/monitor-query-readme?view=azure-node-latest). Note that we use the pay-as-you go pricing tier ($3.22 per GB) with a free 5 GB per month. It works by telling Application Insights to feed its data to the workspace (done via Monitoring -> Diagnostic Settings), which can then be queried via the API.

**[Authentication](https://github.com/Azure/azure-sdk-for-js/blob/@azure/monitor-query_1.0.2/sdk/identity/identity/README.md#defaultazurecredential) of the `monitor-query` package**
When developing locally, we [authenticate](https://github.com/Azure/azure-sdk-for-js/blob/main/sdk/identity/identity/README.md#authenticate-via-visual-studio-code) via the Azure Account extension (**version 0.9.10**). Run the `sign in` VSCode command to commence the session. When generating the client during runtime, the `DefaultAzureCredential` will automatically read this sign-in session from VSCode.

When deployed to Azure, the `MANAGED_IDENTITY_CLIENT_ID` points the credential handler to the managed identity that we want to use, and no further authentication should be required to get things working.

# .env
Define `local.env`, `debug.env` and `release.env` files that set the following environment variables, one per line, in the format `KEY=value`. The `template.env` file can be used as a template. **On Azure, these variables must be set manually in the app service's configuration.**

The following environment variables must be set in the `.env` file:
- `PORT`: Which port the server should run on.
- `AUTH`: The authentication credentials for the livestream user. Optional. Credentials can be obtained by running the electron app via `yarn auth`, logging into the Google account, and copying the encoded cookie token that is displayed in the console.
- `CHANNEL_ID`: The channel ID of the livestream user.
- `TWITCH_CLIENT_ID`: The client ID for twitch auth (from https://dev.twitch.tv/console/apps).
- `TWITCH_CLIENT_SECRET`: The client secret for twitch auth.
- `TWITCH_CHANNEL_NAME`: The Twitch channel's name from which we should connect (must have at least moderator permissions).
- `STREAMLABS_ACCESS_TOKEN`: The access token for the Streamlabs account associated with the broadcaster's account. It can be found at https://streamlabs.com/dashboard#/settings/api-settings
- `STREAMLABS_SOCKET_TOKEN`: The WebSocket token for the Streamlabs account associated with the broadcaster's account. It can be found at https://streamlabs.com/dashboard#/settings/api-settings
- `DATABASE_URL`: The connection string to the MySQL database that Prisma should use. **Please ensure you append `?pool_timeout=30&connect_timeout=30` to the connection string (after the database name)** to prevent timeouts during busy times. More options can be found at https://www.prisma.io/docs/concepts/database-connectors/mysql
  - The local database connection string for the debug database is `mysql://root:root@localhost:3306/chat_mate_debug?connection_limit=5&pool_timeout=30&connect_timeout=30`
  - The remote database connection string for the debug database is `mysql://chatmateadmin:{{password}}@chat-mate.mysql.database.azure.com:3306/chat_mate_debug?connection_limit=5&pool_timeout=30&connect_timeout=30`
- `ENABLE_DB_LOGGING`: [Optional, defaults to `false`] Whether to include database-related actions in the logs. Note that, even if this is `false`, any warning and errors will still be included.
- `DB_SEMAPHORE_CONCURRENT`: [Optional, defaults to `1000`] How many concurrent database requests to allow, before queuing any new requests. Note that operations on the Prisma Client generate many direct database requests, so this number shouldn't be too low (> 50).
- `DB_SEMAPHORE_TIMEOUT`: [Optional, defaults to `null`] The maximum number of milliseconds that a database request can be queued before timing it out. If null, does not timeout requests in the queue.
- `DB_TRANSACTION_TIMEOUT`: [Optional, defaults to `5000`] The maximum number of milliseconds a Prisma transaction can run before being cancelled and rolled back.
- `MANAGED_IDENTITY_CLIENT_ID`: The Client ID of the Managed Identity that is used to access the Log Analytics workspace for querying logs.
- `LOG_ANALYTICS_WORKSPACE_ID`: The Client ID of the Log Analytics Workspace that is attached to the Application Insights for the current server App Service instance.

The following set of environment variables is available only for **local development** (that is, where `NODE_ENV`=`local`):
- `USE_FAKE_CONTROLLERS`: [Optional, defaults to `fa
lse`] If true, replaces some controllers with test-only implementations that generate fake data. This also disables communication with external APIs (that is, it is run entirely offline).

The following set of environmnet variables is available only for **deployed instances** (that is, where `NODE_ENV`=`debug` || `NODE_ENV`=`release`):
- `APPLICATIONINSIGHTS_CONNECTION_STRING`: The connection string to use for connecting to the Azure Application Insights service. *This is set automatically by Azure.*
- `HOST_NAME`: The host name at which the deployed server is reachable, e.g. `example.com`. *This is set automatically by Azure.*

In addition, the following environment variables must be injected into the node instance using the `cross-env` package:
- `NODE_ENV`: Either `local`, `debug` or `release` to indicate which servers we are connecting to. Some behaviour is different when running the server locally than when the server is deployed.

Finally, the following environment variables must be present in the `<local|debug|release>.env` file when building via webpack. These are not checked at runtime, and ommitting them leads to undefined behaviour.
- `NAME`: A unique name to give this build.
- `STUDIO_URL`: The URL to ChatMate studio.

For testing, define a `test.env` file that sets only a subset of the above variables:
- `DATABASE_URL`

## Database

The `local` and `debug` MySQL database is named `chat_mate_debug`, while the `release` database is named `chat_mate`, and the `test` databases are named `chat_mate_test` and `chat_mate_test_debug`. Ensure the `DATABASE_URL` connection string is set in the respective [`.env`](#.env) file.

`Prisma` is used as both the ORM and typesafe interface to manage communications with the underlying MySQL database. Run `yarn migrate:debug` to sync the local DB with the checked-out migrations and generate an up-to-date Prisma Client.

At any point where the prisma file (`prisma.schema` - the database schema) is modified, `yarn generate` can be run to immediately regenerate the Prisma Client for up-to-date typings. This should also be run if the project structure changes in some way. No actual database changes are performed as part of this command. For more help and examples with using the Prisma Client and querying, see https://www.prisma.io/docs/concepts/components/prisma-client.


### Migrations
Run `yarn migrate:schema` to generate a new `migration.sql` file for updating the MySQL database, which will automatically be opened for editing. Note that while this migration is not applied, any earlier unapplied migrations will be executed prior to generating the new migration. All outstanding migrations can be applied explicitly, and a new Prisma Client generated, using `yarn migrate:apply`.

During a migration, ensure that the `.sql` is checked and edited to avoid data loss, but avoid making manual changes that affect the database schema, other than the ones already present.

Migrations are autoamtically run in CI during the deployment process. This occurs during the last step before deployment, but it is still possible that something goes wrong where the migration succeeds, but deployment fails. For this reason, migrations should follow an expand and contract pattern.

## Punishments
Punishments are used to temporarily or permanently hide users' livestream messages. Any punishment can be revoked at any time. Punishment reasons and revoke reasons are supported but optional. Punishments can be either temporary or permanent, depending on the type.

Currently there are 3 punishment types:
1. `mute`: This is an internal punishment, and is used by the client to hide messages of a certain user. A mute can be temporary or permanent.
2. `timeout`: This is both internal and external (i.e. sent to YouTube and Twitch) and completely stops the user from sending messages in the livestream chat. It is always temporary. Due to limitations with the Masterchat implementation, timeouts must be at least 5 minutes long. Furthermore, we have a service that refreshes YouTube timeouts periodically if they are longer than 5 minutes.
3. `ban`: This is essentially a permanent timeout.

## Testing
`yarn test` performs the test suite.
`yarn test:db` Sets up the test database.
`yarn test <file regex>` includes only tests within files matching the expression.

Further, to filter individual tests, temporarily replace `test()` with `test.only()`. All `test()`s will then be skipped.

Due to concurrency issues, all tests using the test database will need to be run from the central `_test/stores.test.ts` file. It imports the `<StoreName>.suite.ts` files which contain the actual test, then run them one-by-one.

### Current test coverage
Over time, aim to add tests to all public methods of all services and stores.
Key:
- ðŸ”´: No tests
- ðŸŸ¡: In progress/incomplete tests
- ðŸŸ¢: Full test coverage
- âšª: Won't do

**Services**
- ðŸŸ¢ AdminService
  - ðŸŸ¢ getAdminUsers
- âšª ApiService
- âšª ApplicationInsightsService
- ðŸŸ¢ ChannelService
  - ðŸŸ¢ getActiveUserChannels
  - ðŸŸ¢ getUserByChannelName
  - ðŸŸ¢ getUserById
- ðŸŸ¢ ChatService
  - ðŸŸ¢ initialise
  - ðŸŸ¢ onNewChatItem
- ðŸŸ¢ ChatFetchService
  - ðŸŸ¢ initialise
- ðŸŸ¢ DonationFetchService
  - ðŸŸ¢ initialise
- ðŸŸ¢ DonationService
  - ðŸŸ¢ linkUserToDonation
  - ðŸŸ¢ unlinkUserFromDonation
- ðŸŸ¢ EmojiService
  - ðŸŸ¢ applyCustomEmojis
- ðŸŸ¢ ExperienceService
  - ðŸŸ¢ addExperienceForChat
  - ðŸŸ¢ getLeaderboard
  - ðŸŸ¢ getLevels
  - ðŸŸ¢ getLevelDiffs
  - ðŸŸ¢ modifyExperience
- âšª EventDispatchService
- âšª HelixEventService
- ðŸŸ¢ LivestreamService
  - ðŸŸ¢ initialise
  - ðŸŸ¢ deactivateLivestream
  - ðŸŸ¢ setActiveLivestream
- ðŸŸ¢ LogQueryService
  - âšª onWarning
  - âšª onError
  - ðŸŸ¢ queryCriticalLogs
  - âšª queryCriticalLogs_
- ðŸŸ¢ MasterchatProxyService
  - ðŸŸ¢ addMasterchat
  - ðŸŸ¢ fetch
  - ðŸŸ¢ fetchMetadata
  - ðŸŸ¢ removeMasterchat
  - ðŸŸ¢ banYoutubeChannel
  - ðŸŸ¢ timeout
  - ðŸŸ¢ unbanYoutubeChannel
  - ðŸŸ¢ mod
  - ðŸŸ¢ unmod
- ðŸŸ¢ ModService
  - ðŸŸ¢ setModRank
- ðŸŸ¢ PunishmentService
  - ðŸŸ¢ initialise
  - ðŸŸ¢ banUser
  - ðŸŸ¢ isUserPunished
  - ðŸŸ¢ muteUser
  - ðŸŸ¢ timeoutUser
  - ðŸŸ¢ getCurrentPunishments
  - ðŸŸ¢ getPunishmentHistory
  - ðŸŸ¢ unbanUser
  - ðŸŸ¢ unmuteUser
  - ðŸŸ¢ untimeoutUser
- ðŸŸ¢ RankService
  - ðŸŸ¢ getAccessibleRanks
- âšª StreamlabsProxyService
- ðŸŸ¢ StatusService
  - ðŸŸ¢ getApiStatus
  - ðŸŸ¢ onRequestDone
- ðŸŸ¢ TwurpleApiProxyService
  - âšª ban
  - ðŸŸ¢ fetchMetadata
  - âšª mod
  - âšª say
  - âšª timeout
  - âšª unmod
- ðŸŸ¢ TwurpleService
  - ðŸŸ¢ banChannel
  - ðŸŸ¢ initialise
  - ðŸŸ¢ modChannel
  - ðŸŸ¢ unbanChannel
  - ðŸŸ¢ unmodChannel
- ðŸŸ¢ YoutubeTimeoutRefreshService
  - ðŸŸ¢ startTrackingTimeout
  - ðŸŸ¢ stopTrackingTimeout
- âšª FileService
- âšª LogService

**Stores**
- ðŸŸ¢ AuthStore
  - ðŸŸ¢ loadAccessToken
  - ðŸŸ¢ saveAccessToken
- ðŸŸ¢ ChannelStore
  - ðŸŸ¢ createOrUpdate
  - ðŸŸ¢ getCurrentUserIds
  - ðŸŸ¢ getCurrentUserNames
  - ðŸŸ¢ getTwitchUserNameFromChannelId
  - ðŸŸ¢ getYoutubeChannelNameFromChannelId
  - ðŸŸ¢ getUserId
  - ðŸŸ¢ getUserOwnedChannels
- ðŸŸ¢ ChatStore
  - ðŸŸ¢ addChat
  - ðŸŸ¢ getChatSince
  - ðŸŸ¢ getLastChatByYoutubeChannel
  - ðŸŸ¢ getLastChatOfUsers
- ðŸŸ¢ CustomEmojiStore
  - ðŸŸ¢ addCustomEmoji
  - ðŸŸ¢ getAllCustomEmojis
  - ðŸŸ¢ updateCustomEmoji
- ðŸŸ¢ DonationStore
  - ðŸŸ¢ addDonation
  - ðŸŸ¢ getDonationsByUserId
  - ðŸŸ¢ getDonationsSince
  - ðŸŸ¢ getLastStreamlabsId
  - ðŸŸ¢ linkUserToDonation
  - ðŸŸ¢ unlinkUserFromDonation
- ðŸŸ¢ ExperienceStore
  - ðŸŸ¢ addChatExperience
  - ðŸŸ¢ addManualExperience
  - ðŸŸ¢ getExperience
  - ðŸŸ¢ getSnapshot
  - ðŸŸ¢ getPreviousChatExperience
  - ðŸŸ¢ getAllTransactionsStartingAt
  - ðŸŸ¢ getTotalDeltaStartingAt
- ðŸŸ¢ FollowerStore
  - ðŸŸ¢ getFollowersSince
  - ðŸŸ¢ saveNewFollower
- ðŸŸ¢ LivestreamStore
  - ðŸŸ¢ initialise
  - ðŸŸ¢ currentLivestream
  - ðŸŸ¢ deactivateLivestream
  - ðŸŸ¢ setActiveLivestream
  - ðŸŸ¢ setContinuationToken
  - ðŸŸ¢ setTimes
- ðŸŸ¢ PunishmentStore
  - ðŸŸ¢ addPunishment
  - ðŸŸ¢ getPunishments
  - ðŸŸ¢ getPunishmentsForUser
  - ðŸŸ¢ revokePunishment
- ðŸŸ¢ RankStore
  - ðŸŸ¢ addUserRank
  - ðŸŸ¢ getRanks
  - ðŸŸ¢ getUserRankById
  - ðŸŸ¢ getUserRanks
  - ðŸŸ¢ getUserRanksForGroup
  - ðŸŸ¢ getUserRankHistory
  - ðŸŸ¢ removeUserRank
  - ðŸŸ¢ updateRankExpiration
- ðŸŸ¢ ViewershipStore
  - ðŸŸ¢ addLiveViewCount
  - ðŸŸ¢ addViewershipForChatParticipation
  - ðŸŸ¢ getLastSeen
  - ðŸŸ¢ getLatestLiveCount
  - ðŸŸ¢ getLivestreamParticipation
  - ðŸŸ¢ getLivestreamViewership

**Providers**
- âšª LogsQueryClientProvider
- ðŸŸ¢ TwurpleAuthProvider
  - ðŸŸ¢ initialise

**Helpers**
- âšª DateTimeHelpers
  - âšª now
  - âšª ts
- ðŸŸ¢ DonationHelpers
  - ðŸŸ¢ isEligibleForDonator
  - ðŸŸ¢ isEligibleForMember
  - ðŸŸ¢ isEligibleForSupporter
- ðŸŸ¢ ExperienceHelpers
  - ðŸŸ¢ calculateChatMessageQuality
  - ðŸŸ¢ calculateExperience
  - ðŸŸ¢ calculateLevel
  - ðŸŸ¢ calculateParticipationMultiplier
  - ðŸŸ¢ calculateQualityMultiplier
  - ðŸŸ¢ calculateRepetitionPenalty
  - ðŸŸ¢ calculateSpamMultiplier
  - ðŸŸ¢ calculateViewershipMultiplier
- ðŸŸ¢ RankHelpers
  - ðŸŸ¢ isRankActive
- ðŸŸ¢ TimerHelpers
  - ðŸŸ¢ createRepeatingTimer
  - ðŸŸ¢ disposeSingle
  - ðŸŸ¢ dispose

**Misc**
- ðŸ”´ util/math
- ðŸ”´ util/score
- ðŸ”´ util/arrays


# API Endpoints

Use the API endpoints to communicate with the server while it is running. The API base URL is `http://localhost:3010/api`.

A response contains the following properties:
- `schema` (`number`): The current schema of the return object. Every time there is a change, this will be bumped up by one to avoid inconsistencies between the server and client.
- `timestamp` (`number`): The unix timestamp (in ms) at which the response was generated.
- `success` (`boolean`): True if the request was processed correctly, and false otherwise.
- `data` (`object`): Only included if `success` is `true`. Contains the response data, outlined for each endpoint below.
- `error` (`object`): Only included if `success` is `false`. Contains the following properties:
  - `errorCode` (`number`): The HTTP error code that most closely matches the type of problem encountered.
  - `errorType` (`string`): The general type of error encounterd.
  - `message` (`string`): An optional error message describing what went wrong.

Note that a `500` error can be expected for all endpoints, but any other errors should be documented specifically in the below sections.

All non-primitive properties of `data` are of type `PublicObject`, which are reusable, schema-tagged objects which themselves contain either primitive types or other `PublicObject`s. The schema definitions for these can be found in the `./controllers/public` folder and will not be reproduced here. Please ensure the client's model is in sync at all times. The schema of an object should be bumped whenever a property of this object, or one of its children changes. That is, schema changes should cascade upwards until reaching the controller levels.

Any data in the request body should also have a schema. This is always in sync with the schema version of the response object.

## Chat Endpoints
Path: `/chat`.

### `GET`
*Current schema: 8.*

Retrieves the latest chat items.

Query parameters:
- `since` (`number`): *Optional.* Gets only chat items **after** the given time (unix ms).
- `limit` (`number`): *Optional.* Limits the number of returned chat items. Defaults to 100.

Returns data with the following properties:
- `reusableTimestamp` (`number`): The timestamp of the latest chat item. Use this value as the `since` query parameter in the next request for continuous data flow (no duplicates).
- `chat` (`PublicChatItem[]`): The chat data that satisfy the request filter, sorted in ascending order by time.

## ChatMate Endpoints
Path: `/chatMate`.

### `GET /status`
*Current schema: 3.*

Gets the latest status information.

Returns data with the following properties:
- `livestreamStatus` (`PublicLivestreamStatus | null`): Status information relating to the active public livestream. Null if there is no active public livestream.
- `youtubeApiStatus` (`PublicApiStatus`): Status information relating to the YouTube API.
- `twitchApiStatus` (`PublicApiStatus`): Status information relating to the YouTube API.

### `GET /events`
*Current schema: 5.*

Gets the events that have occurred since the specified time.

Query parameters:
- `since` (`number`): *Required.* Gets only events **after** the given time (unix ms).

Returns data with the following properties:
- `reusableTimestamp` (`number`): Use this value as the `since` query parameter in the next request for continuous data flow (no duplicates).
- `events` (`PublicChatMateEvent[]`): The list of events that have occurred since the given timestamp.

Can return the following errors:
- `400`: When the required query parameters have not been provided.

### `PATCH /livestream`
*Current schema: 2.*

Sets the active public livestream. Note that an active livestream cannot be set if another one is already active. Please deactivate the existing one first (see below).

Request data (body):
- `livestream` (`string | null`): *Required.* The livestream link or id to set as active. If `null`, the active stream will be deactivated.

Returns data with the following properties:
- `livestreamLink` (`string | null`): The new livestream link.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.
- `422`: When an active livestream already exists.

### `GET /masterchat/authentication`
*Current schema: 1.*

Check whether the currently active Masterchat instance is authenticated.

Returns data with the following properties:
- `authenticated` (`boolean | null`): Whether the Masterchat instance is authenticated.
  - `true`: The Masterchat instance is authenticated.
  - `false`: The Masterchat instance is not authenticated. This could be because the provided credentials are invalid, or have expired. Actions requiring a logged-in user will fail (e.g. livestream moderation).
  - `null`: Unknown - no Masterchat instance is active, or authentication has not been verified yet.

## Donation Endpoints
Path: `/donation`.

### `GET /`
*Current schema: 1.*

Gets all donations.

Returns data with the following properties:
- `donations` (`PublicDonation[]`): The list of all donations.

### `POST /link`
*Current schema: 1.*

Links a user to a donation.

Query parameters:
- `donationId` (`number`): The ID of the donation to which the user should be linked.
- `userId` (`number`): The user to link to the donation.

Returns data with the following properties:
- `updatedDonation` (`PublicDonation`): The updated donation that now includes the linked user.

Can return the following errors:
- `400`: When the request data is not sent, or when a user is already linked to the given donation.

### `DELETE /link`
*Current schema: 1.*

Unlinks a user to a donation.

Query parameters:
- `donationId` (`number`): The ID of the donation from which the user should be unlinked.

Returns data with the following properties:
- `updatedDonation` (`PublicDonation`): The updated donation that no longer includes the linked user.

Can return the following errors:
- `404`: When the request data is not sent, or when no user was linked to the given donation.

## Emoji Endpoints
Path: `/emoji`.

### `GET /custom`
*Current schema: 1.*

Gets all custom emojis.

Returns data with the following properties:
- `emojis` (`PublicCustomEmoji[]`): The list of all custom emojis.

### `POST /custom`
*Current schema: 1.*

Add a new custom emoji.

Request data (body):
- `newEmoji` (`PublicCustomEmojiNew`): *Required.* The new emoji's data. Note that the `symbol` must be unique, otherwise the request will get rejected.

Returns data with the following properties:
- `newEmoji` (`PublicCustomEmoji`): The new emoji that was created.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `PATCH /custom`
*Current schema: 1.*

Update an existing custom emoji.

Request data (body):
- `updatedEmoji` (`PublicCustomEmoji`): *Required.* The updated emoji's data. Note that the `symbol` must be unique, otherwise the request will get rejected. The `id` is used to match the new emoji to an emoji in the database.

Returns data with the following properties:
- `updatedEmoji` (`PublicCustomEmoji`): The updated emoji data.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

## Experience Endpoints
Path: `/experience`.

### `GET /leaderboard`
*Current schema: 4.*

Gets the ranked experience list of all users.

Returns data with the following properties:
- `rankedUsers` (`PublicRankedUser[]`): The array of every user's rank, sorted in ascending order.

### `GET /rank`
*Current schema: 4.*

Gets the rank of a specific user, as well as some context. Essentially, it returns a sub-section of the data from `GET /leaderboard`.

Query parameters:
- `id` (`number`): *Required.* The id of the user for which the rank is to be returned.

Returns data with the following properties:
- `relevantIndex` (`number`): The index of the entry in `entries` that belongs to the matched channel. Never negative.
- `rankedUsers` (`PublicRankedUser[]`): The partial leaderboard in ascending order, which includes the matched channel. Never empty.

Can return the following errors:
- `400`: When the required query parameters have not been provided.
- `404`: When no channel could be matched against the search query.

### `POST /modify`
*Current schema: 3.*

Modifies a player's experience by adding a special admin transaction.

Request data (body):
- `userId` (`int`): *Required.* The user whose experience should be modified.
- `deltaLevels` (`float`): *Required.* How many levels to add or take away. This can be a fractional value. A user's current fractional level is given by `levelInfo.level + levelInfo.levelProgress`.
  message: (`string`): *Optional.* A custom message to add as part of the transaction.

Returns data with the following properties:
- `updatedUser` (`PublicUser`): The user object after the experience change has been applied.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.
- `404`: When the given user is not found.

## Log Endpoints
Path: `/log`.

### `GET /timestamps`
*Current schema: 1.*

Gets timestamps of warnings and errors encountered within the last 24 hours.

Returns data with the following properties:
- `timestamps` (`PublicLogTimestamps`): The timestamps of warnings and errors.

## Punishment Endpoints
Path: `/punishment`.

### `GET /:id`
*Current schema: 2.*

Gets a punishment by id.

Path parameters:
- `id` (`number`): *Required.* The ID of the punishment to retrieve.

Returns data with the following properties:
- `punishment` (`PublicUserRank`): The punishment matching the specified id.

Can return the following errors:
- `404`: When a punishment with the specifed id could not be found.

### `GET`
*Current schema: 2.*

Gets the list of current or historical punishments.

Query parameters:
- `userId` (`number`): *Required if `includeInactive` is `true`, otherwise optional.* The ID of the user for which to get the punishment list. If not provided, returns active punishments for all users.
- `includeInactive` (`boolean`): *Optional.* If true, returns the list of historical punishments (active and inactive) for a user. If false, returns punishments that are currently active, either for all users or the provided user.

Returns data with the following properties:
- `punishments` (`PublicUserRank[]`): The list of punishments of the user, in descending order by time issued.

Can return the following errors:
- `400`: When the required query parameters have not been provided, or the query parameters are incompatible.

### `POST /ban`
*Current schema: 4.*

Applies a punishment of type `ban` to the user, which is essentially a permanent `timeout`. This endpoint may also be used to apply bans to any channels which may not currently be banned.

Request data (body):
- `userId` (`int`): *Required.* The user to which the punishment should be applied.
- `message` (`string`): *Optional.* The reason for the punishment.

Returns data with the following properties:
- `newPunishment` (`PublicUserRank | null`): The new punishment that was created as a result of this request, if successful.
- `newPunishmentError` (`string | null`): If `newPunishment` is `null`, the error that was encountered when attempting to add the punishment.
- `channelPunishments` (`PublicChannelRankChanges[]`): The external punishments applied to channels on YouTube or Twitch.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `POST /unban`
*Current schema: 4.*

Revokes an existing `ban` punishment from the user. This may also be used to remove any residual bans on the external platforms.

Request data (body):
- `userId` (`int`): *Required.* The user from which the punishment should be revoked.
- `message` (`string`): *Optional.* The reason for revoking the punishment.

Returns data with the following properties:
- `removedPunishment` (`PublicUserRank | null`): The punishment that was removed, if successful.
- `removedPunishmentError` (`string | null`): If `removedPunishment` is `null`, the error that was encountered when attempting to remove the punishment.
- `channelPunishments` (`PublicChannelRankChanges[]`): The external punishments revoked from channels on YouTube or Twitch. Note that these are executed regardless of whether an internal punishment was found or not.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `POST /timeout`
*Current schema: 4.*

Applies a punishment of type `timeout` to the user, which is essentially a temporary `ban`. This endpoint may also be used to apply timeouts to any channels which may not currently be timed out.

Request data (body):
- `userId` (`int`): *Required.* The user to which the punishment should be applied.
- `message` (`string`): *Optional.* The reason for the punishment.
- `durationSeconds` (`number`): *Required.* The duration of the punishment, in seconds. Must be at least 5 minutes.

Returns data with the following properties:
- `newPunishment` (`PublicUserRank | null`): The new punishment that was created as a result of this request, if successful.
- `newPunishmentError` (`string | null`): If `newPunishment` is `null`, the error that was encountered when attempting to add the punishment.
- `channelPunishments` (`PublicChannelRankChanges[]`): The external punishments applied to channels on YouTube or Twitch.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `POST /revokeTimeout`
*Current schema: 3.*

Revokes an existing `timeout` punishment from the user. This may also be used to remove any residual timeouts on the external platforms.

Request data (body):
- `userId` (`int`): *Required.* The user from which the punishment should be revoked.
- `message` (`string`): *Optional.* The reason for revoking the punishment.

Returns data with the following properties:
- `removedPunishment` (`PublicUserRank | null`): The punishment that was removed, if successful.
- `removedPunishmentError` (`string | null`): If `removedPunishment` is `null`, the error that was encountered when attempting to remove the punishment.
- `channelPunishments` (`PublicChannelPunishment[]`): The external punishments revoked from channels on YouTube or Twitch. Note that these are executed regardless of whether an internal punishment was found or not.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `POST /mute`
*Current schema: 2.*

Applies a punishment of type `mute` to the user.

Request data (body):
- `userId` (`int`): *Required.* The user to which the punishment should be applied.
- `message` (`string`): *Optional.* The reason for the punishment.
- `durationSeconds` (`number`): *Optional.* The duration of the punishment, in seconds. If 0 or not provided, the punishment is permanent.

Returns data with the following properties:
- `newPunishment` (`PublicUserRank`): The new punishment that was created as a result of this request.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly. This error is also returned when a mute is already active for the given user.

### `POST /unmute`
*Current schema: 3.*

Revokes an existing `mute` punishment from the user.

Request data (body):
- `userId` (`int`): *Required.* The user from which the punishment should be revoked.
- `message` (`string`): *Optional.* The reason for revoking the punishment.

Returns data with the following properties:
- `removedPunishment` (`PublicUserRank`): The rank that was removed.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.
- `404`: When an active mute was not found for the given user.


## Rank Endpoints
Path: `/rank`.

Note: For punishment-specific functionality, refer to the [punishment endpoints](#punishment-endpoints).

### `GET`
*Current schema: 1.*

Gets the list of current or historical user-ranks.

Query parameters:
- `userId` (`number`): *Required.* The ID of the user for which to get the list of ranks.
- `includeInactive` (`boolean`): *Optional.* If true, returns the list of historical ranks (active and inactive) for a user. If false, returns only ranks that are currently active.

Returns data with the following properties:
- `ranks` (`PublicUserRank[]`): The list of ranks of the user, in descending order by time issued.

Can return the following errors:
- `400`: When the required query parameters have not been provided.


### `GET /accessible`
*Current schema: 1.*

Gets the ranks accessible to the current user. At the moment, it returns all Regular ranks and Punishment ranks.

Returns data with the following properties:
- `accessibleRanks` (`PublicRank[]`): The list of ranks accessible to the user.

### `POST`
*Current schema: 1.*

Adds a Regular rank to the specified user.

Request data (body):
- `rank` (`string`): *Required.* The name of the rank to add. Should be one of the following: `famous`, `donator`, `supporter`, `member`.
- `userId` (`int`): *Required.* The user to which the rank should be added.
- `message` (`string`): *Optional.* A custom message to accompany the rank addition.
- `durationSeconds` (`number`): *Optional.* The duration of the rank, in seconds, after which it should automatically expire. If 0 or not provided, the rank is permanent.

Returns data with the following properties:
- `newRank` (`PublicUserRank`): The new user-rank that was added.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly. This error is also returned when a rank of the specified type is already active for the given user.

### `DELETE`
*Current schema: 1.*

Removes a regular rank from the specified user.

Request data (body):
- `rank` (`string`): *Required.* The name of the rank to remove. Should be one of the following: `famous`, `donator`, `supporter`, `member`.
- `userId` (`int`): *Required.* The user from which the rank should be removed.
- `message` (`string`): *Optional.* A custom message to accompany the rank removal.

Returns data with the following properties:
- `removedRank` (`PublicUserRank`): The rank that was removed.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.
- `404`: When an active rank of the specified type was not found for the given user.

### `POST /mod`
*Current schema: 1.*

Add the `mod` rank to the specified user.

Request data (body):
- `userId` (`int`): *Required.* The user to which the rank should be added.
- `message` (`string`): *Optional.* A custom message to accompany the rank addition.

Returns data with the following properties:
- `newRank` (`PublicUserRank | null`): The new rank that was added, if successful.
- `newRankError` (`string | null`): If `newRank` is `null`, the error that was encountered when attempting to add the rank.
- `channelModChanges` (`PublicChannelRankChange[]`): The external updates made to channels on YouTube or Twitch.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.

### `DELETE /mod`
*Current schema: 1.*

Remove the `mod` rank from the specified user.

Request data (body):
- `userId` (`int`): *Required.* The user from which the rank should be removed.
- `message` (`string`): *Optional.* A custom message to accompany the rank removal.

Returns data with the following properties:
- `removedRank` (`PublicUserRank | null`): The rank that was removed, if successful.
- `removedRankError` (`string | null`): If `removedRank` is `null`, the error that was encountered when attempting to remove the rank.
- `channelModChanges` (`PublicChannelRankChange[]`): The external updates made to channels on YouTube or Twitch.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.


## User Endpoints
Path: `/user`.

### `POST /search`
*Current schema: 4.*

Search for a specific user.

Request data (body):
- `searchTerm` (`string`): *Required.* The string to search in user's channel names.

Returns data with the following properties:
- `results` (`PublicUserNames[]`): An array containing the users with matching channel names. If no match was found, the array is empty. Users are sorted in ascending order according to the match quality, with the first user having the best match.

Can return the following errors:
- `400`: When the request data is not sent, or is formatted incorrectly.
